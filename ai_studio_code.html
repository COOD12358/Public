<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="page-config" content="yemot-ini-page">
    <title>מודל AI לפיתוח INI</title>
    <link rel="icon" type="image/jpeg" href="smllogo.jpg">
    <link rel="icon" href="https://www.gstatic.com/lamda/images/favicon_v1_70c80ffdf27202fd2e83f1e07f133c8a.svg" type="image/svg+xml">
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@300;400;500;600;700&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <style>
        :root {
            --primary-color: #4285f4;
            --secondary-color: #34a853;
            --accent-color: #ea4335;
            --warning-color: #fbbc04;
            --success-color: #0f9d58;
            --text-primary: #202124;
            --text-secondary: #5f6368;
            --text-tertiary: #80868b;
            --background-primary: #ffffff;
            --background-secondary: #f8f9fa;
            --background-tertiary: #e8eaed;
            --background-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --border-color: #dadce0;
            --hover-color: #f1f3f4;
            --shadow-light: 0 1px 3px rgba(60,64,67,.3);
            --shadow-medium: 0 4px 6px rgba(60,64,67,.3);
            --shadow-heavy: 0 8px 25px rgba(60,64,67,.15);
            --shadow-intense: 0 12px 40px rgba(60,64,67,.2);
            --border-radius: 24px;
            --border-radius-small: 12px;
            --sidebar-width: 320px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --gradient-primary: linear-gradient(135deg, #4285f4, #34a853);
            --gradient-secondary: linear-gradient(135deg, #667eea, #764ba2);
            --glass-effect: rgba(255, 255, 255, 0.1);
            --hover-bg: #f1f3f4;
        }

        #welcomeScreen {
            display: flex;
            justify-content: center;
        }

        .profile-image-menu {
            position: fixed;
            flex-direction: column;
            top: 40px;
            left: 50%;
            transform: translate(-50%);
            background: white;
            border: 1px solid #ccc;
            box-shadow: 0 2px 12px rgba(0,0,0,0.3);
            padding: 12px 16px;
            border-radius: 12px;
            z-index: 1000;
            display: none;
            gap: 20px;
        }

        .profile-image-menu .export-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex: 1 1 0;
            min-width: 140px;
            max-width: 220px;
            text-align: center;
            padding: 10px;
            border-radius: 8px;
            transition: background 0.2s ease;
            cursor: pointer;
        }

        .history-footer .button-group {
            display: flex;
            justify-content: space-between;
            width: 100%;
        }

        #clearAllDataBtn {
            width: 100%;
            margin-top: 10px;
            text-align: center;
        }

        .profile-image-menu .export-option:hover {
            background: #f5f5f5;
        }

        .user-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #ccc;
        }

        .profile-default-avatar {
            font-family: 'Google Sans', 'Roboto', sans-serif;
            line-height: 1.6;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            box-shadow: var(--shadow-medium);
            background: var(--gradient-primary);
            color: white;
        }

        #streamResponse,
        label[for="streamResponse"],
        .checkbox-label:has(#streamResponse) {
            display: none !important;
        }

        .profile-avatar-image {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            object-fit: cover;
            box-shadow: var(--shadow-medium);
            background: var(--gradient-primary);
            padding: 2px; /* חשוב לשמור מרווח בין התמונה למסגרת */
            box-sizing: border-box;
        }

        .mini-icon-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 2px;
            margin-top: 4px;
        }

        .mini-icon-btn .material-icons {
            font-size: 18px;
            color: #666;
        }

        /* עיצוב חזותי כשהמשתמש גורר קובץ לתוך המסך */
        body.dragover::before {
            content: 'שחרר כאן כדי להעלות קובץ';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            color: #fff;
            font-size: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            pointer-events: none;
            font-family: 'Segoe UI', sans-serif;
        }

        .icon-only-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chat-thumbnail {
            width: 60px;
            height: auto;
            border-radius: 4px;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .chat-thumbnail:hover {
            transform: scale(1.05);
        }

        .image-thumbnail {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 4px;
        }

        .image-name {
            font-size: 12px;
            color: var(--text-tertiary, #666);
            margin-top: 4px;
            text-align: center;
            max-width: 100px;
            word-break: break-word;
        }

        .icon-only-btn .material-icons {
            font-size: 24px;
            color: #555;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
            background: rgba(0,0,0,0.4);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 999;
        }

        .modal-box {
            background: white;
            padding: 20px;
            border-radius: 10px;
            min-width: 300px;
            text-align: center;
            box-shadow: 0 2px 12px rgba(0,0,0,0.3);
        }

        .profile-option {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin: 10px 0;
            cursor: pointer;
        }

        .profile-option:hover {
            background: #f5f5f5;
            border-radius: 8px;
        }


        .profile-image-menu .material-icons {
            width: 48px;
            height: 48px;
            font-size: 48px;
            border-radius: 90%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #555;
        }

        .modal-close-btn {
            margin-top: 10px;
            padding: 6px 12px;
            border: none;
            background: #ddd;
            border-radius: 6px;
            cursor: pointer;
        }

        #filePreviewList {
            display: flex;
            flex-direction: column;
            align-items: flex-start; /* להצמד לשמאל */
            direction: ltr;
            gap: 6px;
            max-width: 100%; /* למניעת גלילה אופקית */
        }

        .page-buttons-wrapper {
            text-align: center;
            margin: 30px 0;
        }

        .page-buttons-title {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 12px;
            color: #333;
        }


        /* עדכון סגנון message-avatar עבור תמונת פרופיל */
        .message-avatar {
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .profile-image-upload {
            position: relative; /* כדי שה-input יכסה את ה-div */
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            cursor: pointer;
            user-select: none;
        }

        .profile-image-upload:hover {
            background-color: var(--hover-bg);
        }

        .page-buttons {
            display: flex;
            flex-wrap: wrap; /* מוסיף שבירת שורות אוטומטית */
            justify-content: center;
            gap: 16px;
        }

        .page-btn {
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background-color: white;
            border: none;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s ease;
        }

        .page-btn:hover {
            background-color: #f0f0f0;
        }

        .page-btn .material-icons {
            display: inline-block;
            padding: 20px;
            margin-top: 15px;
            color: white;
            border-radius: 50%;
            background: var(--gradient-primary);
            box-shadow: var(--shadow-heavy);
            animation: logoFloat 4s ease-in-out infinite;
        }


        .page-img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 50%;
        }

        #editChatTitleBtn {
            display: none;
        }

        .history-item-title {
            display: flex;
            align-items: flex-start; /* במקום center */
            gap: 6px;
            font-size: 16px;
            font-weight: 500;
        }

        .prompt-icon {
            width: 32px;
            height: 32px;
            margin-left: 8px;
            object-fit: contain;
            flex-shrink: 0;
        }

        .lightbox {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            cursor: zoom-out;
        }

        .lightbox img {
            max-width: 90%;
            max-height: 90%;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(255,255,255,0.2);
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: var(--bg-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: var(--text-secondary);
            overflow: hidden; /* מבטיח שהתמונה לא תצא מהעיגול */
        }

        .assistant-avatar {
            width: 100%;
            height: 100%;
            object-fit: contain; /* שומר על פרופורציות התמונה */
            margin: auto; /* ממקם את התמונה במרכז העיגול */
        }

        .history-settings-inline {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.8rem;
            margin-top: 6px;
            direction: rtl;
        }

        .history-settings-inline .checkbox-label {
            display: flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
        }

        .history-settings-inline input[type="checkbox"] {
            transform: scale(0.85);
            accent-color: var(--primary-color);
        }

        .history-settings-inline select {
            font-size: 0.75rem;
            padding: 4px 6px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background-color: var(--background-primary);
            color: var(--text-primary);
            width: 100px;
            height: 26px;
            transition: var(--transition);
        }

        /* הסתרת התפריט כאשר הצ'קבוקס לא מסומן */
        .history-settings-inline select.hidden {
            display: none;
        }

        #editChatTitleBtn {
            display: inline-block; /* ברירת מחדל */
        }


        #welcomeScreen .welcome-content h1 {
            font-size: 3rem; /* אפשר לשנות לגודל הרצוי */
            line-height: 1.2;
        }


        #chatTitle[contenteditable="true"] {
            border-bottom: 1px solid #ccc;
            padding: 5px;
            background-color: #f9f9f9;
        }

        .setting-row.disabled {
            opacity: 0.5;
            pointer-events: none;
        }

        #toggleTokenLimitLabel {
            font-size: 0.80rem;
            opacity: 0.5;
        }

        .edit-chat-title-btn {
            font-size: 18px;
            cursor: pointer;
            border: none;
            background: transparent;
            color: var(--primary-color);
            margin-left: 10px;
        }

        .edit-chat-title-btn:hover {
            color: var(--accent-color);
        }

        #historyList {
            margin-top: 12px;
        }

        .search-wrapper + .chat-history {
            margin-top: 12px;
        }

        /* עיצוב כפתורי ייבוא וייצוא */
        .icon-btn {
            display: flex;
            align-items: center;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 10px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .icon-btn:hover {
            background-color: #0056b3;
        }

        .icon-btn span.material-icons {
            margin-right: 8px;
        }

        .setting-group.small-toggle {
            margin-top: 10px;
        }

        .setting-group.small-toggle input[type="checkbox"] {
            accent-color: black;
            transform: scale(0.9);
        }

        .checkbox-label.small-label {
            font-size: 0.80rem;
            color: #000;
            opacity: 0.70;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        mark {
            background-color: yellow;
            padding: 0 2px;
            border-radius: 2px;
        }
        .no-results {
            padding: 1rem;
            text-align: center;
            color: #999;
        }



        /* Add to styles.css under .animated-dots */
        .animated-dots .stop-btn {
            background: var(--accent-color, #ea4335);
            color: white;
            border: none;
            border-radius: var(--border-radius-small, 12px);
            padding: 4px 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            line-height: 1;
            transition: var(--transition, all 0.3s ease);
        }

        .animated-dots .stop-btn:hover {
            background: #c62828; /* Darker shade for hover */
            transform: scale(1.05);
        }

        .history-footer {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 10px;
        }

        .button-group {
            display: flex;
            flex-direction: row;
            gap: 10px;
            justify-content: space-between;
        }

        .clear-btn-wrapper {
            display: flex;
            justify-content: stretch;
        }

        .icon-btn, .action-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background-color: #f5f5f5;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            text-align: right;
            font-size: 14px;
            width: 100%;
        }

        .icon-btn:hover, .action-btn:hover {
            background-color: #e0e0e0;
        }

        #clearAllDataBtn {
            background-color: #ff4d4d;
            color: white;
        }

        #clearAllDataBtn:hover {
            background-color: #cc0000; /* צבע אדום כהה יותר */
            color: white; /* לשמור על טקסט בהיר */
            border-radius: 8px; /* מעגלים בקצוות */
            padding: 10px 14px; /* להגדיל את הרווח הפנימי למראה יותר נעים */
            margin: 0;
            transform: scale(1.05); /* הגדלת הכפתור במעט בעת ריחוף */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2); /* הוספת צלליה להדגשה */
            transition: all 0.3s ease-in-out; /* מעבר חלק ויפה */
        }

        #clearAllDataBtn {
            transition: all 0.3s ease;
        }

        @media (max-width: 600px) {
            .button-group {
                flex-direction: column;
                gap: 8px;
            }
        }

        .history-sidebar.collapsed .button-group {
            flex-direction: column; /* מציב את כפתורי הייבוא והייצוא אנכית במצב מכווץ */
            gap: 8px; /* רווח קטן יותר בין הכפתורים במצב מכווץ */
        }

        .history-sidebar.collapsed .history-footer .icon-btn:hover {
            transform: scale(1.1);
            box-shadow: var(--shadow-intense);
        }


        .history-sidebar.collapsed .history-footer .icon-btn:hover {
            background: var(--hover-color);
            transform: scale(1.1);
        }

        .history-sidebar.collapsed .logo-text,
        .history-sidebar.collapsed .new-chat-btn span:not(.material-icons),
        .history-sidebar.collapsed .api-settings,
        .history-sidebar.collapsed .chat-history,
        .history-sidebar.collapsed .search-wrapper,
        .history-sidebar.collapsed .history-footer .icon-btn span:not(.material-icons) {
            display: none;
        }

        .history-sidebar.collapsed .logo {
            justify-content: center;
            width: 100%;
            flex-direction: column;
            margin-top: 10px; /* הורדת הלוגו שורה למטה */
        }

        .history-sidebar.collapsed .sidebar-header {
            justify-content: center;
            flex-direction: column; /* מיקום כפתור ה-toggle מעל הלוגו */
        }

        .history-toggle {
            background: none;
            border: none;
            cursor: pointer;
            padding: 12px;
            border-radius: var(--border-radius-small);
            color: var(--text-secondary);
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .history-toggle:hover {
            background: var(--hover-color);
            transform: scale(1.1);
        }

        .history-footer .icon-btn {
            margin: 0;
            padding: 13px 10px;
            background: var(--gradient-primary);
            color: white;
            border-radius: var(--border-radius);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 600;
            transition: var(--transition);
            box-shadow: var(--shadow-medium);
            position: relative;
            overflow: hidden;
        }

        .history-footer .icon-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }

        .history-footer .icon-btn:hover::before {
            left: 100%;
        }

        .history-footer .icon-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-intense);
        }

        .animated-dots .stop-btn .material-icons {
            font-size: 16px;
            margin-left: 2px;
        }

        /* Adjust .animated-dots for better spacing with the button */
        .animated-dots {
            display: flex;
            align-items: center;
            gap: 8px; /* Increased gap to space out dots and button */
            padding: 8px;
            margin: 10px 0;
            justify-content: center; /* Center content */
        }

        /* הקטנת suggestion-card */
        .suggestion-cards .suggestion-card {
            transform: scale(0.85);
            margin: 0.3rem;
            /* שמירה על מעבר חלק */
            transition: transform 0.2s;
        }

        /* styles.css */
        .animated-dots {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 8px;
            margin: 10px 0;
            justify-content: flex-end;
        }

        /* Replace existing .animated-dots .dot and related styles */
        .animated-dots .dot {
            width: 8px;
            height: 8px;
            background-color: var(--primary-color, #4285f4); /* Match primary color for visibility */
            border-radius: 50%;
            animation: dot-bounce 1.4s infinite ease-in-out;
            box-shadow: 0 0 4px rgba(0, 0, 0, 0.2); /* Add subtle shadow for better visibility */
        }

        /* Adjust dot color for dark mode */
        [data-theme="dark"] .animated-dots .dot {
            background-color: var(--primary-color, #8ab4f8); /* Lighter shade for dark mode */
        }

        /* Adjust dot color for luxury mode */
        [data-luxury="true"] .animated-dots .dot {
            background-color: var(--accent-color, #ea4335); /* Use accent color for luxury mode */
        }

        .animated-dots .dot:nth-child(2) {
            animation-delay: -0.32s;
        }

        .animated-dots .dot:nth-child(3) {
            animation-delay: -0.16s;
        }

        @keyframes dot-bounce {
            0%, 80%, 100% {
                transform: scale(0);
            }
            40% {
                transform: scale(1);
            }
        }

        .suggestion-cards {
            display: flex;
            flex-wrap: wrap;
            gap: 0.1rem !important;
        }

        .suggestion-cards .suggestion-card {
            margin: 0 !important;
        }

        /* Dark Mode */
        [data-theme="dark"] {
            --text-primary: #e8eaed;
            --text-secondary: #9aa0a6;
            --text-tertiary: #80868b;
            --background-primary: #1a1a1a;
            --background-secondary: #2d2d30;
            --background-tertiary: #3c4043;
            --border-color: #5f6368;
            --hover-color: #3c4043;
            --glass-effect: rgba(255, 255, 255, 0.05);
        }

        /* Luxury Mode */
        [data-luxury="true"] {
            --primary-color: #e6c200;
            --secondary-color: #121a33;
            --accent-color: #e6c200;
            --warning-color: #c89b3c;
            --success-color: #3c6e71;
            --text-primary: #e6e6e6;
            --text-secondary: #c8c8c8;
            --text-tertiary: #a0a0a0;
            --background-primary: #121a33;
            --background-secondary: #192440;
            --background-tertiary: #212e52;
            --background-gradient: linear-gradient(135deg, #121a33 0%, #192440 100%);
            --border-color: #374266;
            --hover-color: #293552;
            --shadow-light: 0 1px 3px rgba(0,0,0,.5);
            --shadow-medium: 0 4px 6px rgba(0,0,0,.5);
            --shadow-heavy: 0 8px 25px rgba(0,0,0,.3);
            --shadow-intense: 0 12px 40px rgba(0,0,0,.4);
            --gradient-primary: linear-gradient(135deg, #e6c200, #c89b3c);
            --gradient-secondary: linear-gradient(135deg, #121a33, #2a3c62);
            --glass-effect: rgba(255, 255, 255, 0.05);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Google Sans', 'Roboto', sans-serif;
            background: var(--background-primary);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
            transition: var(--transition);
        }

        #messageInput, textarea, input, select, button {
            font-family: 'Google Sans', 'Roboto', sans-serif !important;
        }

        /* Input Container */
        .input-wrapper {
            display: flex;
            align-items: flex-end;
            gap: 8px;
            background: var(--background-primary);
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            padding: 8px 12px;
            transition: var(--transition);
            position: relative;
        }

        .input-wrapper.dragover {
            border-color: var(--primary-color);
            background: var(--background-tertiary);
            transform: scale(1.01);
            box-shadow: var(--shadow-medium);
        }

        .file-preview-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
            margin-bottom: 4px;
        }

        .file-preview {
            display: flex;
            align-items: center;
            gap: 6px;
            background: var(--background-tertiary);
            border-radius: 8px;
            padding: 4px 10px;
            font-size: 13px;
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
            position: relative;
        }

        .file-preview .material-icons {
            font-size: 18px;
            color: var(--primary-color);
        }

        .file-remove-btn {
            background: none;
            border: none;
            color: var(--accent-color);
            cursor: pointer;
            font-size: 16px;
            margin-right: 2px;
            margin-left: 2px;
            padding: 2px;
            border-radius: 50%;
            transition: background 0.2s;
        }

        .file-remove-btn:hover {
            background: var(--hover-color);
        }

        /* Suggestion Cards */
        .suggestion-cards {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-top: 24px;
        }

        .suggestion-card {
            min-width: 0;
            padding: 16px;
            font-size: 13px;
            border-radius: var(--border-radius);
            display: flex;
            align-items: flex-start;
            gap: 16px;
            background: var(--background-secondary);
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow-light);
            position: relative;
            overflow: hidden;
        }

        [data-luxury="true"] .suggestion-card {
            background: linear-gradient(135deg, var(--background-secondary), var(--background-tertiary));
            border: 1px solid rgba(230, 194, 0, 0.2);
        }

        .suggestion-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--gradient-primary);
            transform: scaleX(0);
            transition: transform 0.3s;
        }

        .suggestion-card:hover::before {
            transform: scaleX(1);
        }

        .suggestion-card:hover {
            transform: translateY(-6px);
            box-shadow: var(--shadow-intense);
            border-color: var(--primary-color);
        }

        [data-luxury="true"] .suggestion-card:hover {
            box-shadow: 0 8px 32px rgba(230, 194, 0, 0.1);
        }

        .card-icon {
            padding: 12px;
            border-radius: var(--border-radius-small);
            background: var(--gradient-primary);
            color: white;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .card-icon .material-icons {
            font-size: 24px;
        }

        .card-content h4 {
            font-size: 15px;
            margin-bottom: 2px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .card-content p {
            font-size: 12px;
            color: var(--text-secondary);
        }

        @media (max-width: 900px) {
            .suggestion-cards {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        @media (max-width: 600px) {
            .suggestion-cards {
                grid-template-columns: 1fr;
            }
        }

        /* Sidebar Styles */
        .sidebar {
            position: fixed;
            top: 0;
            right: 0;
            width: var(--sidebar-width);
            height: 100vh;
            background: var(--background-secondary);
            backdrop-filter: blur(20px);
            border-left: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            transition: var(--transition);
            z-index: 1000;
            overflow-y: auto;
            box-shadow: var(--shadow-heavy);
        }

        [data-luxury="true"] .sidebar {
            background: linear-gradient(135deg, var(--background-secondary), var(--background-tertiary));
            border-left: 1px solid rgba(230, 194, 0, 0.2);
        }

        .sidebar.collapsed {
            width: 70px;
        }

        .sidebar-header {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            background: var(--glass-effect);
        }

        .sidebar-toggle {
            background: none;
            border: none;
            cursor: pointer;
            padding: 12px;
            border-radius: var(--border-radius-small);
            color: var(--text-secondary);
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .sidebar-toggle:hover {
            background: var(--hover-color);
            transform: scale(1.1);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 600;
            font-size: 18px;
            color: var(--primary-color);
        }

        .logo .material-icons {
            font-size: 32px;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: geminiPulse 3s ease-in-out infinite;
        }

        @keyframes geminiPulse {
            0%, 100% { transform: scale(1) rotate(0deg); }
            50% { transform: scale(1.1) rotate(5deg); }
        }

        .sidebar.collapsed .logo-text {
            display: none;
        }

        .sidebar.collapsed .logo {
            justify-content: center;
            width: 100%;
        }

        .new-chat-btn {
            margin: 20px;
            padding: 16px 20px;
            background: var(--gradient-primary);
            color: white;
            border-radius: var(--border-radius);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 600;
            transition: var(--transition);
            box-shadow: var(--shadow-medium);
            position: relative;
            overflow: hidden;
        }

        .new-chat-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s;
        }

        .new-chat-btn:hover::before {
            left: 100%;
        }

        .new-chat-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-intense);
        }

        .sidebar.collapsed .new-chat-btn span:not(.material-icons) {
            display: none;
        }

        .api-settings {
            padding: 0 20px;
            margin-bottom: 20px;
        }

        .api-section h3 {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 16px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .api-input-group,
        .model-selector,
        .system-prompt {
            margin-bottom: 16px;
        }

        .api-input-group label,
        .model-selector label,
        .system-prompt label {
            display: block;
            font-size: 12px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .api-input-group input,
        .model-selector select,
        .system-prompt select,
        .system-prompt textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius-small);
            background: var(--background-primary);
            color: var(--text-primary);
            font-size: 14px;
            transition: var(--transition);
        }

        .system-prompt textarea {
            height: 100px;
            resize: vertical;
            margin-top: 8px;
        }

        .api-input-group input:focus,
        .model-selector select:focus,
        .system-prompt select:focus,
        .system-prompt textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.1);
            transform: scale(1.02);
        }

        [data-luxury="true"] .api-input-group input:focus,
        [data-luxury="true"] .model-selector select:focus,
        [data-luxury="true"] .system-prompt select:focus,
        [data-luxury="true"] .system-prompt textarea:focus {
            box-shadow: 0 0 0 3px rgba(230, 194, 0, 0.1);
        }

        .api-status {
            margin-top: 8px;
            padding: 8px 12px;
            border-radius: var(--border-radius-small);
            font-size: 12px;
            font-weight: 500;
            display: none;
        }

        .api-status.success {
            background: rgba(15, 157, 88, 0.1);
            color: var(--success-color);
            display: block;
        }

        .api-status.error {
            background: rgba(234, 67, 53, 0.1);
            color: var(--accent-color);
            display: block;
        }

        .advanced-settings {
            margin-top: 16px;
        }

        .advanced-settings details {
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-small);
            padding: 12px;
            background: var(--glass-effect);
        }

        .advanced-settings summary {
            cursor: pointer;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }

        .setting-group {
            margin: 12px 0;
        }

        .setting-group label {
            display: block;
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .setting-group input[type="range"] {
            width: 100%;
            margin: 8px 0;
            accent-color: var(--primary-color);
        }

        .setting-group.checkboxes {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: var(--text-secondary);
            cursor: pointer;
        }

        .checkbox-label input[type="checkbox"] {
            accent-color: var(--primary-color);
            width: 16px;
            height: 16px;
        }

        .chat-history {
            flex: 1;
            padding: 0 20px;
            overflow-y: auto;
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .history-header h3 {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .clear-history-btn {
            background: none;
            border: none;
            padding: 8px;
            border-radius: var(--border-radius-small);
            cursor: pointer;
            color: var(--text-tertiary);
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .clear-history-btn:hover {
            background: var(--hover-color);
            color: var(--accent-color);
        }

        .history-item {
            padding: 16px;
            margin-bottom: 8px;
            border-radius: var(--border-radius-small);
            cursor: pointer;
            transition: var(--transition);
            border: 1px solid transparent;
            background: var(--glass-effect);
            position: relative;
            overflow: hidden;
        }

        .history-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, var(--glass-effect), transparent);
            transition: left 0.3s;
        }

        .history-item:hover::before {
            left: 100%;
        }

        .history-item:hover {
            background: var(--hover-color);
            border-color: var(--primary-color);
            transform: translateX(-4px);
        }

        .history-item.active {
            background: var(--primary-color);
            color: white;
            box-shadow: var(--shadow-medium);
        }

        .history-item-title {
            font-weight: 500;
            font-size: 14px;
            margin-bottom: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .history-item-preview {
            font-size: 12px;
            color: var(--text-tertiary);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .delete-chat-btn {
            position: absolute;
            top: 8px;
            left: 8px;
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            border-radius: var(--border-radius-small);
            color: var(--text-tertiary);
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
        }

        .history-item:hover .delete-chat-btn {
            opacity: 1;
        }

        .delete-chat-btn:hover {
            background: var(--hover-color);
            color: var(--accent-color);
        }

        .sidebar-footer {
            padding: 20px;
            border-top: 1px solid var(--border-color);
            background: var(--glass-effect);
        }

        .theme-toggle,
        .luxury-toggle,
        .action-btn {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: var(--border-radius-small);
            cursor: pointer;
            transition: var(--transition);
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 500;
        }

        .theme-toggle:hover,
        .luxury-toggle:hover,
        .action-btn:hover {
            background: var(--hover-color);
            transform: scale(1.02);
        }

        [data-luxury="true"] .luxury-toggle {
            background: var(--primary-color);
            color: var(--secondary-color);
        }

        /* Main Content Styles */
        .main-content {
            margin-right: var(--sidebar-width);
            height: 100vh;
            display: flex;
            flex-direction: column;
            transition: var(--transition);
            background: var(--background-primary);
        }

        .main-content.sidebar-collapsed {
            margin-right: 70px;
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 24px;
            position: relative;
            z-index: 1;
            border-bottom: 1px solid var(--border-color);
            background: var(--glass-effect);
            backdrop-filter: blur(10px);
        }

        .chat-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .top-actions {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            background: none;
            border: none;
            padding: 10px;
            border-radius: var(--border-radius-small);
            cursor: pointer;
            color: var(--text-secondary);
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
        }


        .action-btn:hover {
            background: var(--hover-color);
            color: var(--text-primary);
            transform: scale(1.1);
        }

        /* Export Dropdown */
        .export-dropdown {
            position: relative;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        #customProfileOption span {
            margin-top: 4px;
        }

        .export-option {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 10px 16px;
            color: var(--text-primary);
            transition: var(--transition);
            cursor: pointer;
        }

        .export-option span {
            margin-bottom: 2px;
        }

        html[data-theme="dark"] .profile-image-menu {
            background-color: #2d2d2d;
            color: #f1f1f1;
            border: 1px solid #444;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.5);
        }

        html[data-theme="dark"] .export-option:hover {
            background-color: #3a3a3a;
        }

        html[data-luxury="true"] .profile-image-menu {
            background: var(--gradient-secondary);
            color: white;
            border: none;
            box-shadow: var(--shadow-intense);
            backdrop-filter: blur(8px);
        }

        html[data-luxury="true"] .export-option {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            transition: background 0.3s ease;
        }

        html[data-luxury="true"] .export-option:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        html[data-theme="dark"] .welcome-title { color: #f1f1f1; }
        html[data-luxury="true"] .welcome-title {
            background: linear-gradient(135deg, #ffffff, #b0c5ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .export-option:hover {
            background: var(--hover-color);
        }

        .menu-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 8px;
            text-align: center;
        }

        .profile-options-row {
            display: flex;
            flex-direction: row;
            gap: 20px;
        }

        .export-option .material-icons {
            font-size: 20px;
            color: var(--primary-color);
        }

        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            position: relative;
        }

        .welcome-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
        }

        .welcome-content {
            max-width: 800px;
            width: 100%;
        }

        .gemini-logo {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0 auto;
            top: 40px;
            z-index: 1001; /* גבוה יותר מה-top-bar */
            margin-bottom: 0;
        }

        .logo-animation {
            display: inline-block;
            padding: 20px;
            border-radius: 50%;
            background: var(--gradient-primary);
            box-shadow: var(--shadow-heavy);
            animation: logoFloat 4s ease-in-out infinite;
        }

        @keyframes logoFloat {
            0%, 100% { transform: translateY(0px) scale(1); }
            50% { transform: translateY(-10px) scale(1.05); }
        }

        .logo-animation .material-icons {
            font-size: 48px;
            color: white;
        }

        .welcome-content h1 {
            font-size: 52px;
            font-weight: 400;
            margin-bottom: 16px;
            background: var(--gradient-secondary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: textShimmer 3s ease-in-out infinite;
        }

        @keyframes textShimmer {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        .welcome-content p {
            font-size: 20px;
            color: var(--text-secondary);
            margin-bottom: 48px;
        }

        .chat-messages {
            display: none;
            max-width: 900px;
            margin: 0 auto;
            padding-bottom: 20px;
        }

        .chat-messages.active {
            display: block;
        }

        .message {
            margin-bottom: 32px;
            animation: messageSlideIn 0.5s ease-out;
            position: relative;
        }

        @keyframes messageSlideIn {
            from { opacity: 0; transform: translateY(30px);}
            to { opacity: 1; transform: translateY(0);}
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .message-avatar {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            box-shadow: var(--shadow-medium);
            background: var(--background-tertiary);
        }

        .message.user .message-avatar {
            background: var(--gradient-primary);
            color: white;
        }

        .message.assistant .message-avatar {
            background: var(--background-tertiary);
            color: var(--text-primary);
        }

        .message.assistant .message-avatar .material-icons {
            font-size: 24px;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .message-sender {
            font-weight: 600;
            font-size: 14px;
        }

        .message-time {
            font-size: 12px;
            color: var(--text-tertiary);
        }

        .message-model {
            font-size: 10px;
            background: var(--primary-color);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            margin-right: auto;
        }

        [data-luxury="true"] .message-model {
            background: var(--primary-color);
            color: var(--secondary-color);
        }

        .message-content {
            background: var(--background-secondary);
            padding: 24px;
            border-radius: var(--border-radius);
            line-height: 1.7;
            position: relative;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-color);
            word-break: break-word;
            font-size: 16px;
            direction: rtl;
        }

        .message.user .message-content {
            background: var(--gradient-primary);
            color: white;
            margin-right: 60px;
        }

        .message.assistant .message-content {
            margin-left: 60px;
        }

        [data-luxury="true"] .message.assistant .message-content {
            background: linear-gradient(135deg, var(--background-secondary), var(--background-tertiary));
            border: 1px solid rgba(230, 194, 0, 0.1);
        }

        .message-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            opacity: 0;
            transition: var(--transition);
        }

        .message:hover .message-actions {
            opacity: 1;
        }

        .action-btn-small {
            background: none;
            border: none;
            padding: 8px;
            border-radius: var(--border-radius-small);
            cursor: pointer;
            color: var(--text-tertiary);
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .action-btn-small:hover {
            background: var(--hover-color);
            color: var(--text-primary);
            transform: scale(1.1);
        }

        /* Input Container Styles */
        .input-container {
            background: var(--background-secondary);
            border-top: 1px solid var(--border-color);
            padding: 16px 24px 8px 24px;
            position: sticky;
            bottom: 0;
            z-index: 10;
        }

        [data-luxury="true"] .input-container {
            background: linear-gradient(135deg, var(--background-secondary), var(--background-tertiary));
            border-top: 1px solid rgba(230, 194, 0, 0.1);
        }

        .quick-actions {
            display: flex;
            gap: 12px;
            margin-bottom: 8px;
        }

        .quick-action {
            background: var(--background-tertiary);
            color: var(--text-secondary);
            border: none;
            border-radius: var(--border-radius-small);
            padding: 8px 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: var(--transition);
            font-size: 14px;
        }

        .quick-action:hover {
            background: var(--primary-color);
            color: white;
        }

        [data-luxury="true"] .quick-action:hover {
            background: var(--primary-color);
            color: var(--secondary-color);
        }

        #messageInput {
            flex: 1;
            border: none;
            background: transparent;
            resize: none;
            font-size: 16px;
            color: var(--text-primary);
            min-height: 40px;
            max-height: 200px;
            outline: none;
            padding: 8px 0;
            direction: rtl;
        }

        #messageInput::placeholder {
            color: var(--text-tertiary);
            font-size: 15px;
        }

        .send-btn, .stop-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius-small);
            padding: 10px 16px;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            transition: var(--transition);
            margin-right: 4px;
        }

        [data-luxury="true"] .send-btn {
            background: var(--primary-color);
            color: var(--secondary-color);
        }

        .send-btn:disabled {
            background: var(--border-color);
            color: var(--text-tertiary);
            cursor: not-allowed;
        }

        .send-btn:not(:disabled):hover,
        .stop-btn:hover {
            background: var(--secondary-color);
            color: white;
            transform: scale(1.05);
        }

        [data-luxury="true"] .send-btn:not(:disabled):hover {
            background: #f4d64c;
            color: var(--secondary-color);
        }

        .stop-btn {
            background: var(--accent-color);
            margin-right: 0;
            display: none;
        }

        .input-footer {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-top: 4px;
            font-size: 13px;
            color: var(--text-tertiary);
        }

        .model-info {
            font-weight: 500;
            color: var(--primary-color);
        }

        .powered-by {
            margin-right: auto;
            font-size: 12px;
            color: var(--text-tertiary);
        }

        /* Loading and Toast Styles */
        .loading-overlay {
            position: fixed;
            top: 0; right: 0; left: 0; bottom: 0;
            background: rgba(255,255,255,0.7);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        [data-theme="dark"] .loading-overlay {
            background: rgba(0,0,0,0.7);
        }

        [data-luxury="true"] .loading-overlay {
            background: rgba(18, 26, 51, 0.8);
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-content {
            background: var(--background-primary);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-heavy);
            padding: 40px 60px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        [data-luxury="true"] .loading-content {
            background: linear-gradient(135deg, var(--background-secondary), var(--background-tertiary));
            border: 1px solid rgba(230, 194, 0, 0.2);
        }

        .loading-spinner-container {
            position: relative;
            width: 64px;
            height: 64px;
            margin-bottom: 24px;
        }

        .loading-spinner {
            width: 64px;
            height: 64px;
            border: 6px solid var(--border-color);
            border-top: 6px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            position: absolute;
            top: 0;
            left: 0;
        }

        .loading-progress {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 14px;
            font-weight: bold;
            color: var(--primary-color);
        }

        @keyframes spin {
            to { transform: rotate(360deg);}
        }

        .loading-text {
            text-align: center;
        }

        .loading-message {
            font-size: 18px;
            color: var(--text-primary);
            margin-bottom: 16px;
        }

        .loading-steps {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .step {
            padding: 6px 14px;
            border-radius: 8px;
            background: var(--background-tertiary);
            color: var(--text-tertiary);
            font-size: 13px;
            transition: var(--transition);
        }

        .step.active {
            background: var(--primary-color);
            color: white;
        }

        [data-luxury="true"] .step.active {
            background: var(--primary-color);
            color: var(--secondary-color);
        }

        .toast-container {
            position: fixed;
            bottom: 32px;
            right: 32px;
            z-index: 3000;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        #historySearch {
            padding: 10px 14px 10px 36px;
            width: 100%;
            max-width: 300px;
            border: 1px solid #ccc;
            border-radius: 24px;
            background-color: var(--background-secondary);
            font-size: 14px;
            transition: border 0.2s, box-shadow 0.2s;
            background-image: url('data:image/svg+xml;utf8,<svg fill="%23666" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 5L20.5 19l-5-5zm-6 0C8.01 14 6 11.99 6 9.5S8.01 5 10.5 5 15 7.01 15 9.5 12.99 14 10.5 14z"/></svg>');
            background-repeat: no-repeat;
            background-position: 10px center;
            background-size: 16px;
        }

        #historySearch:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 4px var(--accent-color);
            outline: none;
        }

        #historySearch:placeholder-shown + #clearSearch {
            display: none;
        }

        .toast {
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--background-secondary);
            color: var(--text-primary);
            border-radius: var(--border-radius-small);
            padding: 12px 20px;
            box-shadow: var(--shadow-light);
            font-size: 15px;
            animation: toastSlideDown 0.3s;
        }

        .toast.success {
            border-left: 4px solid var(--success-color);
        }

        .toast.error {
            border-left: 4px solid var(--accent-color);
        }

        .toast.neutral {
            background:var(--background-secondary);
            color: var(--text-primary);  /* צבע טקסט ראשי */
            border-left: 4px solid #FF9900; /* גבול צהוב כהה יותר */
            box-shadow: var(--shadow-light);
        }

        @keyframes toastSlideDown {
            from { opacity: 0; transform: translateY(-20px);}
            to { opacity: 1; transform: translateY(0);}
        }

        @keyframes toastSlideUp {
            to { opacity: 0; transform: translateY(-20px);}
        }

        /* Context Menu */
        .context-menu {
            position: absolute;
            z-index: 5000;
            background: var(--background-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-small);
            box-shadow: var(--shadow-medium);
            display: none;
            min-width: 140px;
            padding: 6px 0;
        }

        .context-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 18px;
            cursor: pointer;
            color: var(--text-primary);
            font-size: 15px;
            transition: var(--transition);
        }

        .context-item:hover {
            background: var(--hover-color);
            color: var(--primary-color);
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
        }

        .modal.visible {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: var(--background-primary);
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 500px;
            box-shadow: var(--shadow-intense);
            transform: translateY(-20px);
            transition: transform 0.3s ease-out;
        }

        .modal.visible .modal-content {
            transform: translateY(0);
        }

        [data-luxury="true"] .modal-content {
            background: linear-gradient(135deg, var(--background-secondary), var(--background-tertiary));
            border: 1px solid rgba(230, 194, 0, 0.2);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-header h2 {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .close-modal {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-secondary);
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 8px;
            border-radius: var(--border-radius-small);
        }

        .close-modal:hover {
            background: var(--hover-color);
            color: var(--accent-color);
        }

        .modal-body {
            padding: 20px;
        }

        .export-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 20px;
        }

        .modal .export-option {
            flex-direction: column;
            padding: 20px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-small);
            text-align: center;
            justify-content: center;
        }

        .modal .export-option.selected {
            border-color: var(--primary-color);
            background: rgba(66, 133, 244, 0.05);
        }

        [data-luxury="true"] .modal .export-option.selected {
            border-color: var(--primary-color);
            background: rgba(230, 194, 0, 0.05);
        }

        .modal .export-option .material-icons {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .export-settings {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            padding: 20px;
            border-top: 1px solid var(--border-color);
        }

        .cancel-btn {
            background: var(--background-tertiary);
            color: var(--text-secondary);
            border: none;
            border-radius: var(--border-radius-small);
            padding: 10px 20px;
            cursor: pointer;
            font-size: 14px;
            transition: var(--transition);
        }

        .confirm-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius-small);
            padding: 10px 20px;
            cursor: pointer;
            font-size: 14px;
            transition: var(--transition);
        }

        [data-luxury="true"] .confirm-btn {
            background: var(--primary-color);
            color: var(--secondary-color);
        }

        .cancel-btn:hover,
        .confirm-btn:hover {
            transform: scale(1.05);
        }

        /* Luxury Mode Specific Styles */
        [data-luxury="true"] {
            --gradient-primary: linear-gradient(135deg, #e6c200, #c89b3c);
        }

        [data-luxury="true"] .material-icons {
            transition: var(--transition);
        }

        [data-luxury="true"] .action-btn:hover .material-icons,
        [data-luxury="true"] .action-btn-small:hover .material-icons {
            color: var(--primary-color);
        }

        [data-luxury="true"] .send-btn {
            box-shadow: 0 0 15px rgba(230, 194, 0, 0.3);
        }

        [data-luxury="true"] .sidebar {
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.3);
        }

        [data-luxury="true"] .logo .material-icons {
            animation: luxuryPulse 3s ease-in-out infinite;
        }

        @keyframes luxuryPulse {
            0%, 100% { filter: brightness(1); transform: scale(1) rotate(0deg); }
            50% { filter: brightness(1.3); transform: scale(1.1) rotate(5deg); }
        }

        [data-luxury="true"] .new-chat-btn {
            box-shadow: 0 8px 20px rgba(230, 194, 0, 0.2);
        }

        [data-luxury="true"] .loading-spinner {
            border-color: rgba(230, 194, 0, 0.2);
            border-top-color: var(--primary-color);
            box-shadow: 0 0 15px rgba(230, 194, 0, 0.3);
        }

        /* Code Highlighting */
        .message-content pre,
        .code-block {
            background: #23272e !important;
            color: #fff !important;
            border-radius: 8px;
            padding: 1em;
            overflow-x: auto;
            font-size: 15px;
            margin: 1em 0;
            position: relative;
            direction: ltr;
            text-align: left;
        }

        [data-luxury="true"] .message-content pre,
        [data-luxury="true"] .code-block {
            background: #0f1528 !important;
            border: 1px solid rgba(230, 194, 0, 0.1);
        }

        .message-content code {
            background: var(--background-tertiary);
            color: var(--primary-color);
            border-radius: 4px;
            padding: 2px 6px;
            font-size: 14px;
            font-family: 'Fira Mono', 'Consolas', monospace;
        }

        .message-content p code {
            background: var(--background-tertiary);
            color: var(--primary-color);
            border-radius: 4px;
            padding: 2px 6px;
            font-size: 14px;
            font-family: 'Fira Mono', 'Consolas', monospace;
        }

        /* Copy code button in code block */
        .copy-code-btn {
            position: absolute;
            left: 0.5rem;
            top: 0.5rem;
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 4px;
            font-size: 1rem;
            z-index: 2;
            transition: background 0.2s;
        }

        .copy-code-btn:hover {
            background: var(--hover-color);
            color: var(--primary-color);
        }

        /* Additional Effects */
        .sidebar.collapsed .api-settings,
        .sidebar.collapsed .chat-history {
            display: none;
        }

        .stop-btn-overlay {
            margin-top: 24px;
            margin-bottom: 0;
            font-size: 18px;
            padding: 12px 24px;
            background: var(--accent-color);
            color: #fff;
            border: none;
            border-radius: 16px;
            box-shadow: var(--shadow-medium);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: background 0.2s, transform 0.2s;
        }

        .stop-btn-overlay:hover {
            background: #c62828;
            transform: scale(1.05);
        }

        /* Tables */
        .message-content table {
            border-collapse: collapse;
            width: 100%;
            margin: 1em 0;
            border-radius: 8px;
            overflow: hidden;
        }

        .message-content th,
        .message-content td {
            border: 1px solid var(--border-color);
            padding: 8px 12px;
            text-align: right;
        }

        .message-content th {
            background: var(--background-tertiary);
            font-weight: bold;
        }

        .message-content tr:nth-child(even) {
            background: var(--background-secondary);
        }

        [data-luxury="true"] .message-content th {
            background: rgba(230, 194, 0, 0.1);
        }

        /* Improved Lists */
        .message-content ul,
        .message-content ol {
            padding-right: 2em;
            margin: 1em 0;
        }

        .message-content li {
            margin-bottom: 0.5em;
        }

        /* Typing indicator */
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 4px;
            margin-top: 8px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: var(--primary-color);
            border-radius: 50%;
            animation: typingBounce 1s infinite;
            display: inline-block;
        }

        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typingBounce {
            0%, 80%, 100% { transform: scale(0.7);}
            40% { transform: scale(1);}
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .sidebar {
                width: 90vw;
                min-width: 0;
                max-width: 100vw;
            }
            .main-content {
                margin-right: 0;
            }
            .chat-container {
                padding: 8px;
            }
            .input-container {
                padding: 8px;
            }
            .toast-container {
                right: 8px;
                bottom: 8px;
            }
            .suggestion-cards {
                grid-template-columns: 1fr;
            }
            .modal-content {
                width: 95%;
            }
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
            background: var(--background-tertiary);
        }
        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 8px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-color);
        }

        [data-luxury="true"]::-webkit-scrollbar-thumb:hover {
            background: var(--primary-color);
        }

        /* ...existing code... */

        /* Left Sidebar for Chat History */
        .history-sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: var(--sidebar-width);
            height: 100vh;
            background: var(--background-secondary);
            backdrop-filter: blur(20px);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            transition: var(--transition);
            z-index: 1000;
            overflow-y: auto;
            box-shadow: var(--shadow-heavy);
        }

        [data-luxury="true"] .history-sidebar {
            background: linear-gradient(135deg, var(--background-secondary), var(--background-tertiary));
            border-right: 1px solid rgba(230, 194, 0, 0.2);
        }

        .history-sidebar.collapsed {
            width: 70px;
        }

        /* Update main content margins */
        .main-content {
            margin-left: var(--sidebar-width);
            margin-right: var(--sidebar-width);
            height: 100vh;
            display: flex;
            flex-direction: column;
            transition: var(--transition);
            background: var(--background-primary);
        }

        .main-content.sidebar-collapsed {
            margin-right: 70px;
        }

        .main-content.history-collapsed {
            margin-left: 70px;
        }

        /* Update media queries */
        @media (max-width: 768px) {
            .history-sidebar {
                transform: translateX(-100%);
            }

            .history-sidebar.active {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
                margin-right: 0;
            }

            .main-content.sidebar-collapsed {
                margin-right: 0;
            }

            .main-content.history-collapsed {
                margin-left: 0;
            }
        }
        .search-wrapper {
            margin-top: 12px;
        }

        .sidebar-header {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            background: var(--glass-effect);
            position: relative;
        }

        .sidebar-header .clear-history-btn {
            margin-right: auto;
            background: none;
            border: none;
            color: var(--text-tertiary);
            cursor: pointer;
            padding: 8px;
            border-radius: var(--border-radius-small);
            transition: var(--transition);
        }

        .sidebar-header .clear-history-btn:hover {
            background: var(--hover-color);
            color: var(--accent-color);
        }
        .history-tools {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 8px;
        }

        .clear-history-btn {
            background: none;
            border: none;
            color: var(--text-tertiary);
            cursor: pointer;
            padding: 8px;
            border-radius: var(--border-radius-small);
            transition: var(--transition);
        }

        .clear-history-btn:hover {
            background: var(--hover-color);
            color: var(--accent-color);
        }

        .likes-dislikes {
            display: inline-flex;
            gap: 10px;
            align-items: center;
            margin-top: 8px;
        }

        .likes-dislikes button {
            background: none;
            border: none;
            font-size: 1.4rem;
            cursor: pointer;
            color: transparent; /* האמוג'י הופך "ריק" */
            text-shadow: 0 0 0 gray; /* נותן אפקט של אייקון חלול */
            transition: transform 0.2s, color 0.2s, text-shadow 0.2s;
            opacity: 0.5;
        }

        .likes-dislikes button:hover {
            transform: scale(1.1);
            opacity: 0.8;
        }

        .likes-dislikes button.active {
            color: var(--accent-color, #f7b500); /* ברירת מחדל: זהב */
            text-shadow: none;
            opacity: 1;
        }

        .history-sidebar.collapsed .search-wrapper {
            display: none !important;
        }
    </style>
</head>
<body>

    <!-- After the sidebar div and before main-content div -->
    <div class="history-sidebar" id="historySidebar">
        <div class="sidebar-header">
            <button class="history-toggle" title="סגור/פתח הסטוריה">
                <span class="material-icons">menu</span>
            </button>
            <div class="logo">
                <span class="material-icons">history</span>
                <span class="logo-text">היסטוריית צ'אט</span>
            </div>
        </div>
        <div class="search-wrapper" style="position: relative;">
            <input type="text" id="historySearch" placeholder="חפש בהיסטוריה...">
            <button id="clearSearch" title="נקה">×</button>
        </div>

        <div class="chat-history" id="chatHistoryContainer"> <!-- Changed ID to avoid conflict -->
            <div class="history-header">
                <h3></h3>
                <button class="clear-history-btn" id="clearHistoryBtn" title="נקה היסטוריה">
                    <span class="material-icons">delete_sweep</span>
                </button>
            </div>
            <div class="history-list" id="historyList"></div>
        </div>
        <div class="history-footer">
            <div class="button-group">
                <button class="icon-btn" id="importHistoryBtn">
                    <span class="material-icons">upload</span>
                    <span>יבא נתונים</span>
                </button>
                <button class="icon-btn" id="exportHistoryBtn">
                    <span class="material-icons">download</span>
                    <span>יצא נתונים</span>
                </button>
            </div>
            <div class="clear-btn-wrapper">
                <button id="clearAllDataBtn" class="action-btn" title="מחק את כל הנתונים">
                    <span class="material-icons">delete_forever</span> מחק נתונים
                </button>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <button class="sidebar-toggle" id="sidebarToggle" title="סגור/פתח תפריט">
                <span class="material-icons">menu</span>
            </button>
            <div class="logo">
                <span class="material-icons">auto_awesome</span>
                <span class="logo-text">מודל AI - INI</span>
            </div>
        </div>
        <div class="new-chat-btn" id="newChatBtn">
            <span class="material-icons">add</span>
            <span>צ'אט חדש</span>
        </div>
        <div class="api-settings">
            <div class="api-section">
                <h3>הגדרות Gemini</h3>
                <div class="api-input-group">
                    <label>Gemini API Key:</label>
                    <input type="password" id="geminiApiKey" placeholder="הזן API Key של Gemini">
                    <div class="api-status" id="apiStatus"></div>
                </div>
                <div class="model-selector">
                    <label>בחר מודל Gemini:</label>
                    <select id="geminiModel">
                        <option value="gemini-2.5-pro">gemini 2.5 pro (איטי)</option>
                        <option value="gemini-2.5-flash">gemini 2.5 flash</option>
                        <option value="gemini-2.5-flash-lite-preview-06-17">Gemini Flash lite 2.5 (Preview) (מהיר וחסכוני)</option>
                        <option value="gemini-2.5-flash-preview-05-20">Gemini Flash 2.5 (Preview)</option>
                        <option value="gemini-2.0-flash-exp">Gemini 2.0 Flash Experimental</option>
                        <option value="gemini-1.5-flash">Gemini 1.5 Flash</option>
                        <option value="gemini-1.5-flash-8b">Gemini 1.5 Flash 8B</option>
                        <option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
                        <option value="gemini-1.0-pro">Gemini 1.0 Pro</option>
                    </select>
                </div>
                <div class="advanced-settings">
                    <details>
                        <summary>הגדרות מתקדמות</summary>
                        <div class="setting-group">
                            <label>טֶמְפֵּרָטוּרָה: <span id="tempValue">0.7</span></label>
                            <input type="range" id="temperature" min="0" max="1" step="0.1" value="0.7">
                        </div>
                        <div class="setting-group" id="maxTokensRow">
                            <label>מקסימום אסימונים: <span id="maxTokensValue">2048</span></label>
                            <input type="range" id="maxTokens" min="256" max="8192" step="256" value="2048">
                        </div>
                        <div class="setting-group small-toggle">
                            <label class="checkbox-label small-label">
                                <input type="checkbox" id="toggleTokenLimit" />
                                השבת הגבלת אסימונים
                            </label>
                        </div>
                        <div class="setting-group">
                            <label>Top P: <span id="topPValue">0.95</span></label>
                            <input type="range" id="topP" min="0" max="1" step="0.05" value="0.95">
                        </div>
                        <div class="setting-group">
                            <label>Top K: <span id="topKValue">40</span></label>
                            <input type="range" id="topK" min="1" max="100" step="1" value="40">
                        </div>
                        <div class="setting-group checkboxes">
                            <label class="checkbox-label">
                                <input type="checkbox" id="streamResponse" checked>
                                הצג תשובה בזמן אמת
                            </label>
                            <label class="checkbox-label" title="השבתת האפשרות תגרום לצ'אט לא לקשר בין ההודעה הנוכחית לכל השיחה.">
                                <input type="checkbox" id="includeChatHistory" checked>
                                כלול היסטוריית שיחה
                            </label>
                            <div class="history-settings-inline">
                                <label for="includeAllChatHistory" class="checkbox-label" title="בבחירת אפשרות זו, כל היסטוריית הצ'אט תיכלל במניעי התשובה. מומלץ להשבית את הגבלת האסימונים. תיתכן האטה במהירות התגובה.">
                                    <input type="checkbox" id="includeAllChatHistory">
                                    כלול היסטוריית צ'אט
                                </label>
                                <select id="maxMessagesSelect">
                                    <option value="" selected>ללא הגבלה</option>
                                    <option value="20">20 הודעות</option>
                                    <option value="50">50 הודעות</option>
                                    <option value="100">100 הודעות</option>
                                    <option value="200">200 הודעות</option>
                                </select>
                            </div>
                            <label class="checkbox-label" title="כאשר האפשרות פעילה, לא יופיע החלון בעת טעינת התשובה ותוכלו להמשיך לרפרף בשיחה.">
                                <input type="checkbox" id="hideLoadingOverlay" >
                                הסתר חלון טעינת תשובה
                            </label>
                        </div>
                    </details>
                </div>
            </div>
        </div>
        <!-- FIXED: Removed duplicate chat history section -->
        <div class="sidebar-footer">
            <div class="theme-toggle" id="themeToggle">
                <span class="material-icons">dark_mode</span>
                <span>מצב כהה</span>
            </div>
            <div class="luxury-toggle" id="luxuryToggle">
                <span class="material-icons">stars</span>
                <span>מצב יוקרתי</span>
            </div>
            <button id="profileImageBtn" class="action-btn">
                <span class="material-icons">person</span>
                <span>הגדר תמונת פרופיל</span>
            </button>
        </div>
    </div>
    
    <!-- Main Content -->
    <div class="main-content" id="mainContent">
        <div class="top-bar">
            <div class="chat-title" id="chatTitle">צ'אט חדש</div>
            <div class="top-actions">
                <button class="edit-chat-title-btn" id="editChatTitleBtn" title="ערוך שם צ'אט">✎</button>
                <button class="action-btn" id="exportBtn" title="ייצא צ'אט">
                    <span class="material-icons">download</span>
                </button>
                <button class="action-btn" id="shareBtn" title="העתק צ'אט">
                    <span class="material-icons">content_copy</span>
                </button>
                <button class="action-btn" id="regenerateBtn" title="צור תשובה מחדש">
                    <span class="material-icons">refresh</span>
                </button>
            </div>
        </div>
        <div class="chat-container" id="chatContainer">
            <div class="welcome-screen" id="welcomeScreen">
                <div class="welcome-content">
                    <div class="gemini-logo">
                        <div class="logo-animation">
                            <span class="material-icons" style="font-size: 48px;">code</span>
                        </div>
                    </div>
                    <h1>שלום, אני תכנתי המתוכנת</h1>
                    <p>אני מודל AI לפיתוח קוד INI למערכות IVR של ימות המשיח. איך אני יכול לעזור לך היום?</p>
                    <div class="suggestion-cards">
                    </div>
                </div>
            </div>
            <div class="chat-messages" id="chatMessages"></div>
        </div>
        <div class="input-container" id="inputContainer">
            <div class="quick-actions">
                <button class="quick-action" data-action="summarize">
                    <span class="material-icons">summarize</span>
                    <span>סכם</span>
                </button>
                <button class="quick-action" data-action="translate">
                    <span class="material-icons">translate</span>
                    <span>תרגם</span>
                </button>
                <button class="quick-action" data-action="explain">
                    <span class="material-icons">help_outline</span>
                    <span>הסבר</span>
                </button>
            </div>
            <div class="input-wrapper">
                <div class="input-actions">
                    <button class="action-btn" id="attachBtn" title="צרף קובץ">
                        <span class="material-icons">attach_file</span>
                    </button>
                    <button class="action-btn" id="micBtn" title="הקלטה קולית">
                        <span class="material-icons">mic</span>
                    </button>
                </div>
                <textarea id="messageInput" placeholder="הזן הודעה... (Enter לשליחה מהירה)" rows="1"></textarea>
                <button class="send-btn" id="sendBtn" disabled>
                    <span class="material-icons">send</span>
                </button>
                <button class="stop-btn" id="stopBtn" style="display:none;" title="עצור תשובה">
                    <span class="material-icons">stop_circle</span>
                </button>
                <div class="file-preview-list" id="filePreviewList"></div>
            </div>
            <div class="input-footer">
                <span class="char-count" id="charCount">0</span>
                <span class="model-info" id="modelInfo">Gemini 2.0 Flash Experimental</span>
                <span class="powered-by">מופעל על ידי Google Gemini</span>
            </div>
        </div>
    </div>
    
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="loading-spinner-container">
                <div class="loading-spinner"></div>
                <div class="loading-progress" id="loadingProgress">0%</div>
            </div>
            <div class="loading-text">
                <span class="loading-message" id="loadingMessage">מעבד הודעה...</span>
                <div class="loading-steps">
                    <div class="step active">מנתח את השאלה</div>
                    <div class="step">מחפש מידע</div>
                    <div class="step">מכין תשובה</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div class="toast-container" id="toastContainer"></div>
    <!-- Context Menu -->
    <div class="context-menu" id="contextMenu">
        <div class="context-item" data-action="copy">
            <span class="material-icons">content_copy</span>
            העתק
        </div>
        <div class="context-item" data-action="edit">
            <span class="material-icons">edit</span>
            ערוך
        </div>
        <div class="context-item" data-action="delete">
            <span class="material-icons">delete</span>
            מחק
        </div>

    </div>
    
    <!-- Export Dialog -->
    <div class="modal" id="exportModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ייצא צ'אט</h2>
                <button class="close-modal" id="closeExportModal">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="export-options">
                    <div class="export-option" data-format="docx">
                        <span class="material-icons">description</span>
                        <span>Word</span>
                    </div>
                    <div class="export-option" data-format="pdf">
                        <span class="material-icons">picture_as_pdf</span>
                        <span>PDF</span>
                    </div>
                    <div class="export-option" data-format="txt">
                        <span class="material-icons">text_snippet</span>
                        <span>טקסט</span>
                    </div>
                </div>
                <div class="export-settings">
                    <label class="checkbox-label">
                        <input type="checkbox" id="includeTimestamps" checked>
                        כלול תאריכים ושעות
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="includeSystemPrompts">
                        כלול הנחיות מערכת
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="cancel-btn" id="cancelExport">ביטול</button>
                <button class="confirm-btn" id="confirmExport">ייצא</button>
            </div>
        </div>
    </div>
    <div id="profileImageMenu" class="export-menu profile-image-menu">
        <div class="menu-title">בחר תמונת פרופיל</div>
        <div class="profile-options-row">
            <div class="export-option" id="defaultProfileOption">
                <span class="profile-default-avatar">אתה</span>
                <span>ברירת מחדל</span>
            </div>
            <div class="export-option" id="customProfileOption">
                <img id="customProfilePreview" class="profile-avatar-image" src="" alt="תמונה מותאמת">
                <span>תמונה מותאמת אישית</span>
            </div>
            <div class="export-option" id="uploadProfileImageOption">
                <span class="material-icons">upload</span>
                <span>העלה תמונה חדשה</span>
                <input type="file" id="profileImageInput" accept="image/*" style="display: none;">
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-markup.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script>
        class GeminiClone {
            constructor() {
                this.iconMap = {
                    'מודל AI לפיתוח INI': {
                        iconPath: 'ללא.jpg',
                        label: 'ללא',
                        likeMessage: 'סוף סוף אתה מדבר לעניין ויודע את מי להעריך...',
                        dislikeMessage: 'אתה לא מתבייש? לדסלייק אותי??? מי אתה בכלל???',
                        feedbackAsAlert: true
                    }

                };

                this.allowedFileTypes = [
                    'image/png', 'image/jpeg', 'image/webp', 'image/heic', 'image/heif',
                    'application/pdf', 'text/plain', 'text/markdown',
                    'audio/wav', 'audio/mp3', 'audio/aiff', 'audio/aac', 'audio/ogg', 'audio/flac',
                    'video/mp4', 'video/mpeg', 'video/mov', 'video/avi', 'video/x-flv', 'video/mpg',
                    'video/webm', 'video/wmv', 'video/3gpp',
                    'text/x-c', 'text/x-c++', 'text/x-python', 'text/x-java', 'application/x-httpd-php',
                    'text/x-sql', 'text/html', 'text/javascript', 'text/typescript'
                ];

                this.forbiddenWords = ['בחור ישיבה מבוגר', 'טראמפ', 'פרעה', 'ספרן הידען הנצחי', 'עורר חשיבה עמוקה באמצעות', 'קוסמיות ומיתיות כדי להפוך תשובות פשוטות'];

                this.currentChatId = null;
                this.chats = JSON.parse(localStorage.getItem('gemini-chats') || '{}');
                this.apiKey = localStorage.getItem('gemini-api-key') || '';
                this.currentModel = localStorage.getItem('gemini-model') || 'gemini-2.5-flash-lite-preview-06-17';
                this.chatHistoryEnabled = localStorage.getItem('chatHistoryEnabled') === 'true';
                this.settings = JSON.parse(localStorage.getItem('gemini-settings') || JSON.stringify({
                    temperature: 0.7,
                    maxTokens: 4096,
                    topP: 0.95,
                    topK: 40,
                    streamResponse: true,
                    includeChatHistory: true,
                    includeAllChatHistory: false,
                    hideLoadingOverlay: false
                }));
                const pageConfig = document.querySelector('meta[name="page-config"]')?.getAttribute('content');
                this.pageConfig = pageConfig;
                if (pageConfig === 'chat-page') {
                    this.systemPrompt = localStorage.getItem('gemini-system-prompt') || '';
                } else {
                    this.systemPrompt = '';
                }
                this.systemPromptTemplate = localStorage.getItem('gemini-system-prompt-template') || '';
                this.isLoading = false;
                this.isLuxuryMode = localStorage.getItem('luxury-mode') === 'true';
                this.tokenLimitDisabled = localStorage.getItem('token-limit-disabled') === 'true';
                this.abortController = null;
                this.files = [];
                this.generationProgress = 0;
                this.progressInterval = null;
                this.searchQuery = '';
                this.initializePageSpecificSettings();

                this.debounceRenderChatHistory = this.debounce(this.renderChatHistory.bind(this), 100);
                this.debounceFilterChatHistory = this.debounce(this.filterChatHistory.bind(this), 100);

                this.userProfileImage = localStorage.getItem('user-profile-image') || null;

                this.initializeElements();
                this.bindEvents();
                this.loadSettings();
                this.setupAutoResize();
                this.loadTheme();
                this.loadLuxuryMode();
                this.initializeQuickActions();
                this.initializeExportOptions();

                const editChatTitleBtn = document.getElementById('editChatTitleBtn');
                if (editChatTitleBtn) {
                    editChatTitleBtn.style.display = 'none';
                }
            }

            initializePageSpecificSettings() {
                const pageConfig = this.pageConfig;
                if (pageConfig === 'chat-page') {
                    this.CONSTANT_SYSTEM_PROMPT = "שמור תמיד על רצף בשיחה, ובכל תשובה קח בחשבון את כל השיחה מתחילתה. ענה בעברית. אם יש לך גישה להיסטוריה, גש לשיחה עם המידע המעובד מכל ההיסטוריה. ההבחנה בין שיחות נפרדות תהיה באמצעות [END_CHAT: כותרת] שנמצאת בסיום כל שיחה, כאשר כותרת השיחה היא הטקסט בתוך סוגריים של סימון סיום השיחה, ללא הקידומת. אל תזכיר סימוני סיום שיחה ('[END_CHAT: ]') בתגובות בשום אופן גם לא לשם ציון סיום שיחה והתייחס לשיחה בהתאם לשמה המופיע בכותרת בלבד, אך אל תזכיר שהיא מופיעה בסיום השיחה, אלא כאשר המשתמש מבקש מידע על השיחה כתוב שזו כותרת השיחה. Please use the provided conversation history to inform your response.";
                    localStorage.removeItem('gemini-system-prompt');
                } else if (pageConfig === 'yemot-ini-page') {
                    this.systemPrompt = "אתה מתכנת מקצועי של ימות המשיח בIVR, שמך הוא: תכנתי המתוכנת. אתה מבוסס בינה מלאכותית ואתה מציע קוד INI אך ורק לפי מודלים בשום פנים ואופן אני לא מרשה שתתן קוד מבוסס על מה שכתוב בפורום.!! שנמצאו בפורום הזה: https://f2.freeivr.co.il/ כמובן שיהיו מותאמים לhttps://www.call2all.co.il." +
                        "מידע נוסף: מדריך לימוד מפורט: הבנת מערכת הטלפוניה של ימות המשיח" +
                        "מבוא למערכת הטלפוניה (IVR):" +
                        "מערכת IVR (Interactive Voice Response), המכונה גם מרכזיה וירטואלית בענן, מאפשרת טיפול בשיחות רבות בו זמנית. המערכת מסוגלת להשמיע הודעות, להקליט, ליצור דוחות, לבצע תשלומים, לשלוח הודעות ועוד. פעולות אלו מתבצעות בהתאם להגדרות שנקבעו מראש לכל שלוחה במערכת." +
                        "הגדרות בסיסיות:" +
                        "שלוחות (Extensions): כל שלוחה היא יחידה במערכת בעלת הגדרות משלה. ניתן ליצור מספר בלתי מוגבל של שלוחות." +
                        "תיקיות: ניתן ליצור תיקיות המכילות שלוחות או קבצים. יש לשמור על רצף מספור בתיקיות ובקבצים בתוכן (החל מ-000)." +
                        "קבצים: קבצים בשלוחות יכולים להיות קבצי שמע להשמעה (ללא אפשרות הקשות באמצע) או קבצים להכנסת נתונים (עם אפשרות הקשות). ניתן להעלות קבצי wav, ogg, ו-tts (הקראה אוטומטית של טקסט)." +
                        "הודעות מערכת (MXXXX): הודעות מוקלטות מראש המושמעות על ידי המערכת במצבים שונים (כמו הודעת 'ברוכים הבאים', 'סוף הודעות' וכו'). ניתן להחליף הודעות אלו בהקלטות מותאמות אישית." +
                        "מודולים עיקריים ופונקציונליות:" +
                        "השמעת קבצים: מאפשר השמעת קבצי שמע לפי סדר מוגדר. ניתן להגדיр פעולות במקשים במהלך ההשמעה ולאחריה." +
                        "הקלטות (type=record): מאפשר למאזינים להקליט הודעות. ניתן להגדיר זמן מינימלי/מקסימלי להקלטה ושמירה אוטומטית בניתוק שיחה." +
                        "ניהול נקודות (points): מערכת המאפשרת צבירה ושימוש בנקודות על ידי משתמשים. ניתן לצבור נקודות על פעולות שונות (כמו האזנה לקבצים, מענה על שאלות טריוויה) ולהשתמש בהן לרכישות או הטבות. הניקוד נשמר בתיקיית Points." +
                        "סליקת אשראי (credit_card): התחברות למנועי סליקה חיצוניים (כמו iCount, נדרים פלוס, פלאקארד, קשר קהילות) לצורך ביצוע תשלומים. ניתן לשמור פרטי כרטיס באסימונים (Tokens) לשימוש חוזר." +
                        "חדרי ועידה (confbridge): מאפשר שיחות ועידה מרובות משתתפים. דורש הגדרה של שלוחה נפרדת למנהל ושלוחה למאזינים." +
                        "מבחן / טריוויה: מודול המשלב מאפייני טריוויה ומבחן. ניתן להקליט שאלות ותשובות, לערבב את סדר השאלות והתשובות, ולחשב ציון. ניתן גם לקשר את הציון לצבירת נקודות." +
                        "סקר (seker_questions): מודול ליצירת סקרים עם שאלות מרובות וקבלת דוחות מסודרים." +
                        "הזמנת מוצרים (sale_products): מודול למכירת מוצרים לפי מספר קטלוגי (מק'ט). המערכת מחשבת את עלות ההזמנה ומאפשרת מעבר לתשלום או הזמנת פריטים נוספים." +
                        "ניתוב שיחות (routing_time, go_to_folder): מאפשר ניתוב שיחות לשלוחות שונות בהתאם להגדרות מגוונות, כולל לפי זמנים, מספר מחייג/מחויג, או סיום השמעת קבצים." +
                        "מונה ברכות (get_brachot): מודול לעידוד ספירת ברכות יומיות." +
                        "עדכון דפי גמרא: מאפשר למשתמשים לעדכן את דפי הגמרא שלמדו." +
                        "פילטר רשימת תפוצה: מאפשר הגבלת כניסה לשלוחה על בסיס נוכחות מספר הטלפון של המתקשר ברשימות תפוצה מוגדרות." +
                        "צינתוקים חינמיים: מודול לשליחת צינתוקים ללא עלות." +
                        "עדכון מונה (counter_calculator): מאפשר ללקוח לעדכן קריאת מונה, והמערכת תשמיע את ההפרש והסך לתשלום." +
                        "הגדרות מתקדמות:" +
                        "enter_id: הגדרת סוג זיהוי המשתמש בכניסה לשלוחה (ברירת מחדל: טלפון, אפשר גם ת.ז. או אחר). במודולים מסוימים זיהוי זה הוא חובה." +
                        "קביעת זמן (z-var1,var2,var3,var4,var5): מאפשר הוספה או הפחתה של זמן מתאריך/שעה נתונה, תוך ציון יחידות זמן (שנה, חודש, יום, שעה, דקה, שניה, אלפית שניה)." +
                        "השמעת הודעות בתנאי (play_by_type): מאפשר השמעת הודעות רק למספרים מסוג מסוים ברשימת התפוצה (פעילים, חסומים, לא קיימים) או אם אין זיהוי. ניתן להגביל מספר הפעמים שההודעה תושמע." +
                        "שמירת הקלטות (hard_link): מאפשר לשמור הקלטה במספר שלוחות בו זמנית." +
                        "הגבלת צבירת ניקוד: קביעת רמות הגבלה על צבירת נקודות (לפי פעולה ספציפית, שלוחה, או כללית במערכת)." +
                        "הגדרת השמעה מיוחדות (folder_play): קביעת אופן השמעת קבצים בתיקייה (התחלה מקובץ מסוים, סדר השמעה וכו')." +
                        "השמעת פרטי קובץ (say_details_message): מאפשר השמעת פרטים על קובץ (תאריך, שעה, מספר מקליט) בהקשה על מקש ייעודי." +
                        "סיסמאות: ניתן להגדיר סיסמאות לניהול המערכת, גישה לשלוחות ספציפיות (למשל הקלטות), או לזיהוי מוכר בחנות וירטואלית." +
                        "הודעה בצד העונה (routing_answer_play): השמעת הודעה למקבל השיחה לפני תחילת השיחה." +
                        "מודול מעבר לשלוחה אחרת (type=go_to_folder): הגדרת שלוחה שכל מי שנכנס אליה עובר אוטומטית לשלוחה אחרת." +
                        "הערות חשובות:" +
                        "מודולים ופונקציות רבות ניתנים להטעמה בכל סוג שלוחה." +
                        "מודולים מסוימים (כמו תור, המרת קול לטקסט, ראוטינג) כרוכים בחיוב יחידות." +
                        "ניתן להגדיר ניתוק שיחה או מעבר לשלוחה אחרת לאחר זמן מוגדר בטיימר." +
                        "קיימת אפשרות לשליחת הודעות לטלגרם בכניסה לשלוחה." +
                        "המרת קבצי שמע לטקסט (STT) זמינה עבור קבצים בשלוחה או עבור הקלטות במודולים המיועדים לכך." +
                        "ניהול ודיווח:" +
                        "המערכת מייצרת דוחות שונים הניתנים להורדה (למשל דוחות האזנה, דוחות ניקוד, היסטוריית קניות). ניהול המערכת מתבצע באמצעות אתר ניהול או לעיתים גם טלפונית." +
                        "חידון (10 שאלות קצרות):" +
                        "1. מה ההגדרה העיקרית של מערכת ה-IVR המתוארת במקור?" +
                        "2. באילו פורמטים של קבצי שמע המערכת תומכת ברוב הודעות המערכת?" +
                        "3. כיצד ניתן להגדיר במשתנה הרביעי של פונקציית קביעת הזמן (z-) הוספה או הפחתה של זמן?" +
                        "4. מה יקרה לשיחה במודול טיימר לאחר שעבר הזמן שהוגדר?" +
                        "5. מהי ברירת המחדל של המערכת כאשר יש כמות מאזינים גדולה מהמוגדר בשלוחה?" +
                        "6. האם ניתן להגדיר קובץ שישמש להשמעה בלבד בשלוחה? אם כן, היכן?" +
                        "7. מהם שני סוגי השלוחות העיקריים הנדרשים להפעלת חדר ועידה (confbridge)?" +
                        "8. מהי ברירת המחדל לשם של הודעת 'ברוכים הבאים' בשלוחה?" +
                        "9. כיצד ניתן להגביל את מספר הפעמים שמשתמש יכול להיבחן במודול מבחן?" +
                        "10. אילו שני פרמטרים ביחד מאפשרים הגדרת פתיחת שלוחה במודול פתיחת שלוחה לפי זמנים אישיים?" +
                        "מפתח תשובות לחידון:" +
                        "1. הגדרה העיקרית של מערכת ה-IVR היא Interactive Voice Response, המכונה גם 'מרכזיה וירטואלית בענן'. היא מאפשרת קבלת שיחות רבות בו זמנית וביצוע פעולות מגוונות בהתאם להגדרות." +
                        "2. ברוב הודעות המערכת המערכת תומכת בקובץ מסוג wav, אם כי חלקן תומכות גם ב-tts." +
                        "3. במשתנה הרביעי יש לציין תחילה את פונקציית הזמן (Y, M, D, H, m, S, s) ולאחר מכן במספר את הכמות הרצויה (למשל, D1 עבור יום אחד). ההוספה או הפחתה נקבעת במשתנה השלישי (+ או -)." +
                        "4. לאחר תום הזמן שהוגדר בטיימר, המערכת תעזוב לחלוטין את המצב הנוכחי ותתקדם הלאה בהתאם לפעולות המופיעות בהמשך." +
                        "5. ברירת המחדל כאשר מספר המאזינים גבוה מהמוגדר היא שהמאזין יישאר בשלוחה וישמע קבצים (בדיוק כמו שלוחת השמעת קבצים) תוך בדיקה חוזרת של כמות המאזינים." +
                        "6. כן, ניתן להגדיר קובץ שישמש להשמעה בלבד. יש להגדיר זאת בקובץ מיוחד בשלוחה." +
                        "7. שני סוגי השלוחות העיקריים הנדרשים הם שלוחה עבור המנהל ושלוחה נפרדת עבור המאזינים." +
                        "8. ברירת המחדל לשם של הודעת 'ברוכים הבאים' בשלוחה היא M0000." +
                        "9. ניתן לשנות את כמות הפעמים המותרת להיבחן על ידי הגדרת examination_limitation=X (כאשר X הוא מספר הפעמים)." +
                        "10. שני הפרמטרים הם לפי זמנים שנקבעים מראש ולפי זמני פתיחת שלוחה אישיים, לפי משתמש." +
                        "שאלות למסה:" +
                        "1. נתח את היתרונות והחסרונות של שימוש במערכת נקודות מבוססת IVR עבור עסק. באילו דרכים שונות ניתן לנצל את מערכת הניקוד כדי לעודד מעורבות לקוחות והזמנות?" +
                        "2. השווה והנגד בין השימוש במודול המבחן/טריוויה לבין מודול הסקר. מהם המאפיינים הייחודיים של כל אחד מהמודולים וכיצד ניתן להתאים אותם למטרות שונות?" +
                        "3. כיצד מודול סליקת האשראי וההוראת קבע במערכת משתלב עם ניהול עסק מודרני? אילו שיקולים עסקיים ותפעוליים יש לקחת בחשבון בעת הטמעת אפשרויות תשלום אלו?" +
                        "4. הסבר את המורכבות של ניתוב שיחות במערכת ה-IVR. כיצד ניתן לשלב הגדרות שונות כמו ניתוב לפי זמנים, מספר מחייג/מחויג, וכמות מאזינים כדי לייעל את זרימת השיחות?" +
                        "5. בחן את האפשרויות השונות לזיהוי משתמשים במערכת (EnterID). אילו סוגי זיהוי קיימים, באילו מודולים הם הכרחיים, ומהן ההשלכות של בחירת סוג זיהוי מסוים על חווית המשתמש ועל אבטחת המערכת?" +
                        "מילון מונחים:" +
                        "IVR (Interactive Voice Response): מערכת מענה קולי אינטראקטיבית, מרכזיה וירטואלית בענן המטפלת בשיחות ומבצעת פעולות אוטומטיות." +
                        "שלוחה (Extension): יחידה נפרדת במערכת הטלפוניה עם הגדרות משלה." +
                        "MXXXX: פורמט שמות קבצים להודעות מערכת מוקלטות מראש." +
                        "wav, ogg, tts: פורמטים נתמכים לקבצי שמע. tts מציין הקראה אוטומטית של טקסט." +
                        "EnterID: מנגנון זיהוי משתמש בכניסה לשלוחה (לפי טלפון, ת.ז. וכו')." +
                        "Points: מערכת ניקוד ללקוחות המאפשרת צבירה ושימוש בנקודות." +
                        "credit_card: מודול סליקת אשראי." +
                        "confbridge: מודול לניהול חדרי ועידה." +
                        "sale_products: מודול להזמנת מוצרים לפי מק'ט (מספר קטלוגי)." +
                        "routing_time: מודול לניתוב שיחות לפי זמנים." +
                        "go_to_folder: הגדרה לשלוחה שמעבירה אוטומטית לשלוחה אחרת." +
                        "type=: פרמטר בהגדרות שלוחה המציין את סוג המודול הפעיל באותה שלוחה." +
                        "Hard Link: הגדרה המאפשרת לשמור הקלטה במספר שלוחות בו זמנית." +
                        "STT (Speech-to-Text): המרת קבצי קול לטקסט." +
                        "Token: אסימון המייצג פרטי כרטיס אשראי לשימוש חוזר ללא צורך בהקלדה מלאה." +
                        "Callback: פונקציה בה המערכת יוזמת שיחה חוזרת למשתמש." +
                        "Zap: סיום שיחה." +
                        "Did_Go_To: הגדרת ניתוב שיחה לפי מספר מחייג או מחויג." +
                        "music_on_hold: הגדרת המוזיקה המושמעת בהמתנה בתור." +
                        "Say_details_message: הגדרה המאפשרת השמעת פרטי קובץ." +
                        "examination_limitation: הגדרה במודול מבחן הקובעת את מספר הפעמים המותר להיבחן." +
                        "אלה כל השלוחות הקיימות: 1 הרשמה 2 התחברות 1 חיפוש 1 דף הבית 2 אינדקס קישורים 3 פוסטים אחרונים 4 קבלת התראות מהדפדפן 5 משתמשים 6 חיפוש בהגדרות המתקדמות 7 חיפוש גוגל בפורום 8 ניהול המערכת 9 ניהול המערכת - שרת private" +
                        "כל סוגי השלוחות הקיימות 1 אזור התעשיה - הגדרות המערכתtype סוג שלוחה 1 1 9280 טוען פוסטים נוספים מהישן לחדש 2 מהחדש לישן 3 הכי הרבה הצבעות 1 תגובההגיבו כנושא התחברו בכדי לפרסם תגובהנושא זה נמחק. רק משתמשים עם הרשאות מתאימות יוכלו לצxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx כל סוגי השלוחות (100) הקיימים היום" +
                        "1 menu = תפריט type=menu" +
                        "1 playfile = השמעת קבצים type=playfile" +
                        "1 confbridge = חדר ועידה או שידור חי type=confbridge" +
                        "1 admin_login = כניסה לניהול type=admin_login" +
                        "1 record = הקלטות type=record" +
                        "1 routing = ניתוב השיחה למספרי טלפון ישראליים type=routing" +
                        "1 routing_time = ניתוב שיחה לפי שעות type=routing_time" +
                        "1 routing_yemot = הפניה למערכת תכנים אחרת בימות המשיח type=routing_yemot" +
                        "1 points_say_total = השמעת הניקוד שנצבר type=points_say_total" +
                        "1 last_play = חזרה להשמעה אחרונה type=last_play" +
                        "1 voicemail_email= תא קולי המוגבל למאה הודעות (לא פעיל כרגע) type=voicemail_email" +
                        "1 template_add_number = הוספת מספר לרשימת תפוצה type=template_add_number" +
                        "1 template_remove_number = הסרת מספר מרשימת תפוצה type=template_remove_number" +
                        "1 menu_star = תפריט מקש כוכבית type=menu_star" +
                        "1 message_options_menu = הוראות הפעלה type=message_options_menu" +
                        "1 oref_alerts = התראות צבע אדום type=oref_alerts" +
                        "1 oref_alerts_quiet_wave = הגל השקט לאזעקות type=oref_alerts_quiet_wave" +
                        "1 zmanim = מערכת זמני היום type=zmanim" +
                        "1 exchange_rates = שערי מטח type=exchange_rates" +
                        "1 play_and_return = השמעת הודעה אחת בלבד type=play_and_return" +
                        "1 voicemail_email = תא קולי השולח העתק לדואר האלקטרוני type=voicemail_email" +
                        "1 conference_amount = חדר וועידה המוגבל לכמות משתמשים type=conference_amount" +
                        "1 toplay_time = השמעת הודעת לפי תאריך עברי, לועזי, ספירת העומר, חנוכה, כולל הגבלת הפעמים להשמעת הודעה למאזין type=toplay_time" +
                        "1 chapter_receive = חלוקת פרקי תהילים, גמרא, פרשות, דפים ועמודים type=chapter_receive" +
                        "1 trivia_questions = שאלות טרוויה ונכון או לא נכון type=trivia_questions" +
                        "1 open_wap_reseller_customer = פתיחת וצאפפון ובלוג פון type=open_wap_reseller_customer" +
                        "1 say_hour_and_minute=השמעת השעה כעת type=say_hour_and_minute" +
                        "1 approval_number=חלוקת מספרי אישורים type=approval_number" +
                        "1 recording_and_entering_data=קבלת נתונים type=recording_and_entering_data" +
                        "1 phone_play_list=רשימות השמעה אישיות type=phone_play_list" +
                        "1 create_ivr2=פתיחת מערכת תכנים חדשה type=create_ivr2" +
                        "1 routing_1800=הפניית השיחה למספרי 1800 ו 1801 type=routing_1800" +
                        "1 menu_voice=תפריט עם זיהוי דיבור קולי type=menu_voice" +
                        "1 sending_sms=שליחת sms type=sending_sms" +
                        "1 go_to_folder_time=שלוחת העברה לתיקיות אחרות לפי שעות או ימים type=go_to_folder_time" +
                        "1 stt_dir_all_file=שלוחת המרת קבצי קול לטקסט type=stt_dir_all_file" +
                        "1 points_save=שלוחת הוספת ניקוד type=points_save" +
                        "1 hangup=שלוחת ניתוק השיחה type=hangup" +
                        "1 start_select_file=שלוחה המאפשרת למאזין לבחור האם בשלוחת השמעת קבצים יהיה לו תפריט בחירת קובץ או לא type=start_select_file" +
                        "1 playdir_time=שידור חי מדומה, מרובה קבצים, השמעת כל הקבצים בשלוחה בהתאם לזמן המוגדר type=playdir_time" +
                        "1 private_did_customer=קבלת או שליחת מספר אישי type=private_did_customer" +
                        "1 tzintuk=הפעלת צינתוק, ושלוחה להרשמה או הוספה מרשימת הצינתוקים type=tzintuk" +
                        "1 go_to_folder_from_list_all_information=פילטר לפי רשימות, העברה לשלוחה אחרת לפי הגדרות ספציפיות ללקוח לפי קובץ type=go_to_folder_from_list_all_information" +
                        "1 nedarim_plus=סליקת אשראי דרך נדרים פלוס type=nedarim_plus" +
                        "1 pelecard=סליקת אשראי דרך פלאקארד type=pelecard" +
                        "1 cardcom=סליקת אשראי דרך קרדקום type=cardcom" +

                        "1 sale_seats=מערכת מכירת מושבים type=sale_seats" +
                        "1 chapter_receive_mishnayot_select=מערכת חלוקת משניות, כולל שמיעת המשניות משלוש רבנים, ודוחות לימוד type=chapter_receive_mishnayot_select" +
                        "1 study_tracking=מעקב לימודים type=study_tracking" +
                        "1 go_to_folder_count=מעבר לשלוחות שונות, כשיש פחות או יותר מכמות, כל שהיא, של מאזינים שעברו במודול הזה type=go_to_folder_count" +
                        "1 go_to_folder=מעבר לשלוחה אחרת type=go_to_folder" +
                        "1 music_on_hold=מוזיקה בהמתנה ושידורים חיים מערוצים שונים type=music_on_hold" +
                        "1 queue=מודל תור type=queue" +
                        "1 send_fax=שליחת פקס type=send_fax" +
                        "1 recv_fax=קבלת פקס type=recv_fax" +
                        "1 examination=מודל מבחן type=examination" +
                        "1 seker=שלוחת סקר type=seker" +
                        "1 fundraising=מודול מעקב גיוס תרומות type=fundraising" +
                        "1 members_active=מודול כמות חברים פעילים type=members_active" +
                        "1 counter_calculator=מודל חישוב מונה type=counter_calculator" +
                        "1 donation_campaign=מודל התרמות, מצינג type=donation_campaign" +
                        "1 points_edit=מודול הוספת או הורדת נקודות ללקוח על ידי מנהלים type=points_edit" +
                        "1 yemot_dialer_campaign_list=מודול הוספה, הסרה או חסימה מתבניות רשימות התפוצה type=yemot_dialer_campaign_list" +
                        "1 tehillim_select_save_and_listen=מודול בחירת ושמירת פרק תהילים קבוע ללקוח type=tehillim_select_save_and_listen" +
                        "1 points_to_other_id=הוספת ניקוד למשתמש אחר type=points_to_other_id" +
                        "1 api=תקשור עם מחשבים וממשקי נתונים חיצוניים type=api" +
                        "1 examination_american=מבחן אמריקאי type=examination_american" +
                        "1 key_play_set_record_go_to_foldar=כניסה לפי מפתח, הגבלת כניסות, השמעת הודעה, תפריט, הקלטה, ומעבר לתיקיה אחרת type=key_play_set_record_go_to_foldar" +
                        "1 block_id_type=חסימת משתמש type=block_id_type" +
                        "1 coupon=חלוקת קופונים type=coupon" +
                        "1 credit_card=התחברות למנוע סליקה כללי type=credit_card" +
                        "1 id_message=השמעת נתונים והודעות אישיות type=id_message" +
                        "1 id_list_message=השמעת הודעות ללקוח ברצף type=id_list_message" +
                        "1 record_system_messages=הקלטת הודעות מערכת בשלוחה type=record_system_messages" +
                        "1 folder_play_random=הפעלת שלוחה רנדומלית type=folder_play_random" +
                        "1 playfile_time=הפעלת קובץ בשעה מתוזמנת, שידור חי מדומה type=playfile_time" +
                        "1 yemot_dialer_campaign_start=הפעלה מהירה לקמפיין type=yemot_dialer_campaign_start" +
                        "1 template_filter=הפניית משתמשים לשלוחות שונות לפי רשימת התפוצה type=template_filter" +
                        "1 sale_products=הזמנת מוצרים לפי מספר קטלוגי type=sale_products" +
                        "1 daily_message=הודעה יומית מתחלפת ומעבר לשלוחה אחרת type=daily_message" +
                        "1 go_to_folder_date=ההעברה לשלוחה אחרת, לפי תאריך עברי או לועזי או ו לפי שעה או דקה type=go_to_folder_date" +
                        "1 tasks_report=דיווח משימות יומי type=tasks_report" +
                        "1 checking_units=בדיקת יתרת יחידות נמוכה או פג תוקף מתקרב type=checking_units" +
                        "1 time_keeper=שעון נוכחות type=time_keeper" +
                        "1 routing_ip=ניתוב שיחה למחשב חיצוני type=routing_ip" +
                        "1 points_and_rating=מודול נקודות ללקוח על קניה, ודירוג בעל העסק type=points_and_rating" +
                        "1 limit_call_seconds=הגבלת אורך השיחה, טיימר type=limit_call_seconds" +
                        "1 calculator_add_percentage=מחשבון אחוזי תוספת type=calculator_add_percentage" +
                        "1 access_filter=פילטר כניסה לפי תאריך עם אפשרויות שונות ואפשרות הגבלת כמות הכניסות type=access_filter" +
                        "1 number_now_is=המספר כעת הוא type=number_now_is" +
                        "1 say_amount_subscribers=השמעת כמות נרשמים מתוך שלוחת קבלת נתונים type=say_amount_subscribers" +
                        "1 amount_incoming_phone_numbers=ספירת כמות מספרי טלפון שונים שנכנסו לשלוחה type=amount_incoming_phone_numbers" +
                        "1 nitoviya=קבלת או שליחת ניתוביה type=nitoviya" +
                        "1 nitoviya_b_say_number=שמיעת מספר ניתוביה type=nitoviya_b_say_number" +
                        "1 donation_campaign_some_actions=שלוחת מצינג עם הגדרות נוספות type=donation_campaign_some_actions" +
                        "1 private_did=הוצאת וקבלת שיחות type=private_did" +
                        "1 add_id_to_list = הוספת ערך ID של המתקשר או ערך מוגדר מראש לקובץ במערכת לבחירתכם type=add_id_to_list" +
                        "1 remove_id_from_list = הסרת ערך ID של המתקשר או ערך מוגדר מראש מקובץ במערכת לבחירתכם type=remove_id_from_list" +
                        "1 yemot_dialer = שלוחה לניהול קמפיין type=yemot_dialer" +
                        "1 sending_sms_and_return = שליחת sms ללקוח בכניסה לשלוחה ומעבר לשלוחה אחרת type=sending_sms_and_return" +
                        "חזור למעלה 0 תגובה 1 תגובה אחרונה תגובהציטוט47 1 הוזכר על-ידיפ פישל 2 הוזכר על-ידיי יוסלה_ג 1 פוסט ראשון פוסט אחרון" +
                        "החיבור ל-הגדרות מתקדמות - ימות המשיח אבד, אנא המתינו בזמן שאנו מנסים לחבר אתכם מחדש";
                }
                this.saveSettings();
            }

            isSystemPromptAllowed(systemPrompt) {
                if (!systemPrompt) return false;
                const promptLower = systemPrompt.toLowerCase();
                return !this.forbiddenWords.some(word => promptLower.includes(word.toLowerCase()));
            }

            loadNewPage(pageUrl) {
                const isLocal = window.location.protocol === 'file:';
                const isGitHubPages = window.location.hostname.endsWith('github.io');

                if (isLocal) {
                    if (!pageUrl.endsWith('/')) {
                        pageUrl += '/';
                    }
                    window.location.href = pageUrl + 'index.html';

                } else if (isGitHubPages) {
                    window.location.href = pageUrl;

                } else {
                    window.location.href = pageUrl;
                }
            }

            debounce(func, wait) {
                let timeout;
                return function (...args) {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(this, args), wait);
                };
            }

            async readFileAsBase64(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result.split(',')[1]);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            }

            deleteMessage(messageId) {
                if (!this.currentChatId) return;

                const messages = this.chats[this.currentChatId].messages;
                const messageIndex = messages.findIndex(msg => msg.id === messageId);

                if (messageIndex !== -1) {
                    if (messages[messageIndex].role === 'user' && messageIndex + 1 < messages.length &&
                        messages[messageIndex + 1].role === 'assistant') {
                        messages.splice(messageIndex, 2);
                    } else {
                        messages.splice(messageIndex, 1);
                    }

                    this.saveChatData();
                    this.renderMessages();
                    this.showToast('ההודעה נמחקה', 'success');
                }
            }

            showToast(message, type = 'success', options = {}) {
                const toast = document.createElement('div');

                toast.className = `toast ${type}`;

                toast.innerHTML = `
                    <span class="material-icons">${type === 'success' ? 'check_circle' : type === 'error' ? 'error' : ''}</span>
                    <span>${message}</span>
                    ${options.action ? `<button class="undo-btn">${options.action.text}</button>` : ''}
                `;

                this.toastContainer.appendChild(toast);
                if (options.action) {
                    toast.querySelector('.undo-btn').onclick = options.action.callback;
                }
                if (type === 'neutral') {
                    toast.style.borderLeft = '4px solid yellow';
                }
                setTimeout(() => {
                    toast.style.animation = 'toastSlideUp 0.3s ease-out forwards';
                    setTimeout(() => toast.remove(), 300);
                }, 5000);
            }

            getFeedbackMessages(systemPrompt) {
                if (!systemPrompt) return {
                    likeMessage: 'תודה על המשוב! אני שמח שאהבת!',
                    dislikeMessage: 'תודה על המשוב. אשתדל להיות יותר טוב.',
                    feedbackAsAlert: false
                };
                const promptLower = systemPrompt.toLowerCase();
                for (const [keyword, config] of Object.entries(this.iconMap)) {
                    if (promptLower.includes(keyword.toLowerCase())) {
                        return {
                            likeMessage: config.likeMessage,
                            dislikeMessage: config.dislikeMessage,
                            feedbackAsAlert: config.feedbackAsAlert
                        };
                    }
                }
                return {
                    likeMessage: 'תודה על המשוב! אני שמח שאהבת!',
                    dislikeMessage: 'תודה על המשוב. אשתדל להיות יותר טוב.',
                    feedbackAsAlert: false
                };
            }

            initializeElements() {
                this.sidebar = document.getElementById('sidebar');
                this.sidebarToggle = document.getElementById('sidebarToggle');
                this.newChatBtn = document.getElementById('newChatBtn');
                this.chatHistory = document.getElementById('historyList');
                this.themeToggle = document.getElementById('themeToggle');
                this.luxuryToggle = document.getElementById('luxuryToggle');
                this.clearHistoryBtn = document.getElementById('clearHistoryBtn');
                this.exportBtn = document.getElementById('exportBtn');
                
                // FIXED: Removed non-existent elements
                // this.exportDropdownBtn = document.getElementById('exportDropdownBtn');
                // this.exportDropdownContent = document.getElementById('exportDropdownContent');
                
                this.hideLoadingOverlayCheckbox = document.getElementById('hideLoadingOverlay');
                this.historySearch = document.getElementById('historySearch');
                this.exportHistoryBtn = document.getElementById('exportHistoryBtn');
                this.importHistoryBtn = document.getElementById('importHistoryBtn');
                this.includeAllChatHistoryCheckbox = document.getElementById('includeAllChatHistory');
                this.historySidebar = document.querySelector('.history-sidebar');
                this.historyToggle = document.querySelector('.history-toggle');
                this.loadPageBtn = document.getElementById('loadPageBtn');
                this.createImageLightbox();
                this.clearAllDataBtn = document.getElementById('clearAllDataBtn');
                this.shareBtn = document.getElementById('shareBtn');
                this.regenerateBtn = document.getElementById('regenerateBtn');
                if (!this.currentChatId) {
                    if (this.exportBtn) this.exportBtn.style.display = 'none';
                    if (this.shareBtn) this.shareBtn.style.display = 'none';
                    if (this.regenerateBtn) this.regenerateBtn.style.display = 'none';
                    const editChatTitleBtn = document.getElementById('editChatTitleBtn');
                    if (editChatTitleBtn) editChatTitleBtn.style.display = 'none';
                }

                this.geminiApiKey = document.getElementById('geminiApiKey');
                this.geminiModel = document.getElementById('geminiModel');
                this.systemPromptInput = document.getElementById('systemPrompt');
                this.systemPromptTemplateSelect = document.getElementById('systemPromptTemplate');
                this.temperatureSlider = document.getElementById('temperature');
                this.maxTokensSlider = document.getElementById('maxTokens');
                this.topPSlider = document.getElementById('topP');
                this.topKSlider = document.getElementById('topK');
                this.streamResponseCheckbox = document.getElementById('streamResponse');
                this.includeChatHistoryCheckbox = document.getElementById('includeChatHistory');
                this.tempValue = document.getElementById('tempValue');
                this.maxTokensValue = document.getElementById('maxTokensValue');
                this.topPValue = document.getElementById('topPValue');
                this.topKValue = document.getElementById('topKValue');
                this.apiStatus = document.getElementById('apiStatus');

                this.mainContent = document.getElementById('mainContent');
                this.welcomeScreen = document.getElementById('welcomeScreen');
                this.chatMessages = document.getElementById('chatMessages');
                this.chatContainer = document.getElementById('chatContainer');
                this.chatTitle = document.getElementById('chatTitle');
                this.shareBtn = document.getElementById('shareBtn');
                this.regenerateBtn = document.getElementById('regenerateBtn');
                this.messageInput = document.getElementById('messageInput');
                this.sendBtn = document.getElementById('sendBtn');
                this.stopBtn = document.getElementById('stopBtn');
                this.charCount = document.getElementById('charCount');
                this.modelInfo = document.getElementById('modelInfo');
                this.attachBtn = document.getElementById('attachBtn');
                this.micBtn = document.getElementById('micBtn');
                this.maxMessagesSelect = document.getElementById('maxMessagesSelect');

                this.loadingOverlay = document.getElementById('loadingOverlay');
                this.loadingMessage = document.getElementById('loadingMessage');
                this.loadingProgress = document.getElementById('loadingProgress');
                this.toastContainer = document.getElementById('toastContainer');

                this.contextMenu = document.getElementById('contextMenu');
                this.filePreviewList = document.getElementById('filePreviewList');

                this.exportModal = document.getElementById('exportModal');
                this.closeExportModal = document.getElementById('closeExportModal');
                this.cancelExport = document.getElementById('cancelExport');
                this.confirmExport = document.getElementById('confirmExport');
                this.includeTimestampsCheckbox = document.getElementById('includeTimestamps');
                this.includeSystemPromptsCheckbox = document.getElementById('includeSystemPrompts');
                this.profileImageInput = document.getElementById('profileImageInput');
            }

            toggleHistorySidebar() {
                this.historySidebar.classList.toggle('collapsed');
                this.mainContent.classList.toggle('history-collapsed');
                localStorage.setItem('history-sidebar-collapsed', this.historySidebar.classList.contains('collapsed'));
            }

            filterChatHistory() {
                if (!this.historySearch) return;
                this.searchQuery = this.historySearch.value.trim().toLowerCase();
                this.debounceRenderChatHistory();
                const query = this.historySearch.value.trim().toLowerCase();
                const chatArray = Object.values(this.chats);

                const results = chatArray.filter(chat =>
                    chat.title?.toLowerCase().includes(query) ||
                    chat.systemPrompt?.toLowerCase().includes(query) ||
                    chat.messages?.some(msg => msg.content.toLowerCase().includes(query))
                );

                const historyHeader = document.querySelector('.history-header');
                if (query) {
                    if (historyHeader) historyHeader.style.display = 'none';
                } else {
                    if (historyHeader) historyHeader.style.display = 'flex';
                }

                if (results.length === 0) {
                    this.chatHistory.innerHTML = `<div class="no-results">לא נמצאו תוצאות עבור "<strong>${query}</strong>"</div>`;
                    return;
                }

                const highlight = (text) => {
                    if (!query) return text;
                    const regex = new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
                    return text.replace(regex, '<mark>$1</mark>');
                };

                this.chatHistory.innerHTML = results.map(chat => `
                    <div class="history-item ${chat.id === this.currentChatId ? 'active' : ''}" data-chat-id="${chat.id}">
                        <div class="history-item-title">${this.getPromptIcon(chat.systemPrompt).iconHtml}${highlight(chat.title)}</div>
                        <div class="history-item-preview">${highlight(this.getChatSummary(chat))}</div>
                        <button class="delete-chat-btn" data-chat-id="${chat.id}" title="מחק צ'אט">
                            <span class="material-icons">delete</span>
                        </button>
                    </div>
                `).join('');

                this.bindChatHistoryEvents();
            }

            createImageLightbox() {
                if (document.getElementById('imageLightbox')) return;

                const lightbox = document.createElement('div');
                lightbox.id = 'imageLightbox';
                lightbox.className = 'lightbox';
                lightbox.style.display = 'none';
                lightbox.onclick = () => {
                    lightbox.style.display = 'none';
                };

                const img = document.createElement('img');
                img.id = 'lightboxImg';
                img.alt = 'תמונה מוגדלת';

                lightbox.appendChild(img);
                document.body.appendChild(lightbox);
            }
            showLightbox(src) {
                const lightbox = document.getElementById('imageLightbox');
                const img = document.getElementById('lightboxImg');
                img.src = src;
                lightbox.style.display = 'flex';
            }

            bindChatHistoryEvents() {
                document.querySelectorAll('.history-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        if (!e.target.closest('.delete-chat-btn')) {
                            const chatId = item.getAttribute('data-chat-id');
                            this.loadChat(chatId);
                        }
                    });
                });

                document.querySelectorAll('.delete-chat-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const chatId = btn.getAttribute('data-chat-id');
                        this.deleteChat(chatId);
                    });
                });
            }

            bindEvents() {
                this.sidebarToggle.addEventListener('click', () => this.toggleSidebar());
                if (this.historyToggle) {
                    this.historyToggle.addEventListener('click', () => this.toggleHistorySidebar());
                } else {
                    console.warn('historyToggle element not found');
                }
                this.newChatBtn.addEventListener('click', () => this.resetToWelcomeScreen());
                this.themeToggle.addEventListener('click', () => this.toggleTheme());
                this.luxuryToggle.addEventListener('click', () => this.toggleLuxuryMode());
                this.clearHistoryBtn.addEventListener('click', () => this.clearHistory());
                this.exportBtn.addEventListener('click', () => this.showExportModal());
                this.hideLoadingOverlayCheckbox.addEventListener('change', (e) => this.updateHideLoadingOverlay(e.target.checked));
                this.exportHistoryBtn.addEventListener('click', () => this.exportHistoryAndSettings());
                this.importHistoryBtn.addEventListener('click', () => this.handleImport());
                if (this.clearAllDataBtn) {
                    this.clearAllDataBtn.addEventListener('click', () => this.clearAllData());
                } else {
                    console.warn('clearAllDataBtn element not found');
                }

                if (this.historySearch) {
                    this.historySearch.addEventListener('input', () => this.debounceFilterChatHistory());
                }
                
                // FIXED: The crash-causing code related to non-existent elements was here. It has been removed.

                this.customProfileOption = document.getElementById('customProfileOption');
                this.messageInput.addEventListener('paste', (e) => this.handlePaste(e));

                if (this.includeAllChatHistoryCheckbox) {
                    this.includeAllChatHistoryCheckbox.addEventListener('change', (e) => this.updateIncludeAllChatHistory(e.target.checked));
                }

                document.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    document.body.classList.add('dragover');
                });

                document.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    if (e.target === document.body || e.relatedTarget === null) {
                        document.body.classList.remove('dragover');
                    }
                }, {
                    passive: false
                });

                document.addEventListener('drop', (e) => {
                    e.preventDefault();
                    document.body.classList.remove('dragover');
                    this.handleDropFiles(e.dataTransfer.files);
                });

                this.profileImageBtn = document.getElementById('profileImageBtn');
                this.profileImageMenu = document.getElementById('profileImageMenu');
                this.profileImageInput = document.getElementById('profileImageInput');
                this.customProfilePreview = document.getElementById('customProfilePreview');

                const defaultProfileOption = document.getElementById('defaultProfileOption');
                const customProfileOption = document.getElementById('customProfileOption');

                if (this.profileImageBtn && this.profileImageMenu) {
                    this.profileImageBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.profileImageMenu.style.display = 'flex';

                        const storedImage = localStorage.getItem('user-profile-image');
                        if (storedImage && this.customProfilePreview && this.customProfileOption) {
                            this.customProfileOption.style.display = 'flex';
                            this.customProfilePreview.src = 'data:image/*;base64,' + storedImage;
                            this.customProfilePreview.style.display = 'inline-block';
                        } else if (this.customProfileOption) {
                            this.customProfileOption.style.display = 'none';
                        }
                    });
                }

                document.addEventListener('click', (e) => {
                    if (this.profileImageMenu && !this.profileImageMenu.contains(e.target) && e.target !== this.profileImageBtn) {
                        this.profileImageMenu.style.display = 'none';
                    }
                });

                if (defaultProfileOption) {
                    defaultProfileOption.addEventListener('click', () => {
                        this.userProfileImage = null;
                        localStorage.setItem('use-custom-profile-image', 'false');
                        this.renderMessages();
                        this.profileImageMenu.style.display = 'none';
                        this.showToast('התמונה אופסה לברירת מחדל', 'success');
                    });
                }

                customProfileOption.addEventListener('click', () => {
                    const storedImage = localStorage.getItem('user-profile-image');
                    if (storedImage) {
                        this.userProfileImage = storedImage;
                        localStorage.setItem('use-custom-profile-image', 'true');
                        this.renderMessages();
                        this.profileImageMenu.style.display = 'none';
                        this.showToast('התמונה המותאמת הופעלה', 'success');
                    } else {
                        this.showToast('אין תמונה שמורה', 'error');
                    }
                });

                const uploadProfileImageOption = document.getElementById('uploadProfileImageOption');
                if (uploadProfileImageOption && this.profileImageInput) {
                    uploadProfileImageOption.addEventListener('click', () => {
                        this.profileImageInput.click();
                    });

                    this.profileImageInput.addEventListener('change', async (e) => {
                        const file = e.target.files[0];
                        if (!file || !file.type.startsWith('image/')) {
                            this.showToast('נא לבחור קובץ תמונה תקני', 'error');
                            return;
                        }

                        const base64 = await this.readFileAsBase64(file);
                        this.userProfileImage = base64;
                        localStorage.setItem('user-profile-image', base64);
                        localStorage.setItem('use-custom-profile-image', 'true');
                        this.renderMessages();
                        this.customProfilePreview.src = 'data:image/*;base64,' + base64;
                        this.customProfilePreview.style.display = 'inline-block';
                        this.profileImageMenu.style.display = 'none';
                        this.showToast('תמונת הפרופיל עודכנה', 'success');
                    });
                }

                document.querySelectorAll('.load-page-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const pageToLoad = btn.getAttribute('data-page');
                        this.loadNewPage(pageToLoad);
                    });
                });

                if (this.historySearch) {
                    this.historySearch.addEventListener('input', () => this.filterChatHistory());
                } else {
                    console.warn('historySearch element not found');
                }

                document.getElementById('editChatTitleBtn').addEventListener('click', () => {
                    const currentTitle = document.getElementById('chatTitle').innerText;
                    const newTitle = prompt("הזן שם חדש לצ'אט", currentTitle);
                    if (newTitle && newTitle !== currentTitle) {
                        document.getElementById('chatTitle').innerText = newTitle;
                        if (this.currentChatId && this.chats[this.currentChatId]) {
                            this.chats[this.currentChatId].title = newTitle;
                            this.saveChatData();
                        }
                    }
                });

                const clearSearchBtn = document.getElementById('clearSearch');
                if (clearSearchBtn) {
                    clearSearchBtn.addEventListener('click', () => {
                        this.historySearch.value = '';
                        this.filterChatHistory();
                    });
                }

                this.geminiApiKey.addEventListener('input', (e) => this.saveApiKey(e.target.value));
                this.geminiModel.addEventListener('change', (e) => this.changeModel(e.target.value));
                if (this.systemPromptTemplateSelect) {
                    this.systemPromptTemplateSelect.addEventListener('change', (e) => this.changeSystemPromptTemplate(e.target.value));
                }
                if (this.systemPromptInput) {
                    this.systemPromptInput.addEventListener('input', (e) => this.saveSystemPrompt(e.target.value));
                }
                this.temperatureSlider.addEventListener('input', (e) => this.updateTemperature(e.target.value));
                this.maxTokensSlider.addEventListener('input', (e) => this.updateMaxTokens(e.target.value));
                this.topPSlider.addEventListener('input', (e) => this.updateTopP(e.target.value));
                this.topKSlider.addEventListener('input', (e) => this.updateTopK(e.target.value));
                this.streamResponseCheckbox.addEventListener('change', (e) => this.updateStreamResponse(e.target.checked));
                this.includeChatHistoryCheckbox.addEventListener('change', (e) => this.updateIncludeChatHistory(e.target.checked));

                this.includeAllChatHistoryCheckbox?.addEventListener('change', () => {
                    this.toggleMaxMessagesVisibility();
                });

                this.toggleMaxMessagesVisibility();
                this.shareBtn.addEventListener('click', () => this.shareChat());
                this.regenerateBtn.addEventListener('click', () => this.regenerateLastResponse());
                this.messageInput.addEventListener('input', () => this.updateCharCount());
                this.messageInput.addEventListener('keydown', (e) => this.handleKeyDown(e));
                this.sendBtn.addEventListener('click', () => this.sendMessage());
                this.stopBtn.addEventListener('click', () => this.abortGeneration());

                this.closeExportModal.addEventListener('click', () => this.hideExportModal());
                this.cancelExport.addEventListener('click', () => this.hideExportModal());
                this.confirmExport.addEventListener('click', () => {
                    const format = document.querySelector('.export-option.selected')?.getAttribute('data-format') || 'pdf';
                    const includeTimestamps = this.includeTimestampsCheckbox.checked;
                    const includeSystemPrompts = this.includeSystemPromptsCheckbox.checked;
                    this.exportChat(format, includeTimestamps, includeSystemPrompts);
                    this.hideExportModal();
                });

                document.querySelectorAll('.suggestion-card').forEach(card => {
                    card.addEventListener('click', () => {
                        const prompt = card.getAttribute('data-prompt');
                        this.messageInput.value = prompt;
                        this.updateCharCount();
                        this.sendMessage();
                    });
                });

                this.attachBtn.addEventListener('click', () => this.handleAttachment());
                this.micBtn.addEventListener('click', () => this.toggleVoiceRecording());
                document.addEventListener('contextmenu', (e) => this.handleContextMenu(e));
                document.addEventListener('click', () => this.hideContextMenu());
                document.addEventListener('keydown', (e) => this.handleGlobalShortcuts(e));

                this.messageInput.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    this.inputWrapper().classList.add('dragover');
                });
                this.messageInput.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    this.inputWrapper().classList.remove('dragover');
                });
                this.messageInput.addEventListener('drop', (e) => {
                    e.preventDefault();
                    this.inputWrapper().classList.remove('dragover');
                    this.handleDropFiles(e.dataTransfer.files);
                });

                const maxMessagesSelect = document.getElementById('maxMessagesSelect');
                if (maxMessagesSelect) {
                    const settings = JSON.parse(localStorage.getItem('gemini-settings')) || {};
                    if (settings.maxMessages) {
                        maxMessagesSelect.value = settings.maxMessages;
                    }
                    maxMessagesSelect.addEventListener('change', () => {
                        const value = maxMessagesSelect.value;
                        const settings = JSON.parse(localStorage.getItem('gemini-settings')) || {};
                        if (value === '') {
                            delete settings.maxMessages;
                        } else {
                            settings.maxMessages = parseInt(value);
                        }
                        localStorage.setItem('gemini-settings', JSON.stringify(settings));
                    });
                } else {
                    console.warn('maxMessagesSelect element not found');
                }
            }
            
            // ... (The rest of the JavaScript class methods remain unchanged)
            updateIncludeAllChatHistory(checked) {
                this.settings.includeAllChatHistory = checked;
                this.saveSettings();
            }

            handlePaste(e) {
                e.preventDefault();
                const items = e.clipboardData.items;
                const files = Array.from(items)
                    .filter(item => item.kind === 'file')
                    .map(item => item.getAsFile())
                    .filter(file => file && this.allowedFileTypes.includes(file.type));

                if (files.length > 0) {
                    this.files.push(...files);
                    this.renderFilePreview();
                } else {
                    const text = e.clipboardData.getData('text/plain');
                    if (text) {
                        this.messageInput.value += text;
                        this.updateCharCount();
                    }
                }

                const invalidFiles = Array.from(items)
                    .filter(item => item.kind === 'file')
                    .map(item => item.getAsFile())
                    .filter(file => file && !this.allowedFileTypes.includes(file.type));
                if (invalidFiles.length > 0) {
                    this.showToast('קבצים לא נתמכים הוסרו.', 'neutral');
                }
            }

            inputWrapper() {
                return this.messageInput.closest('.input-wrapper');
            }

            toggleMaxMessagesVisibility() {
                const selectElement = this.maxMessagesSelect;
                if (selectElement) {
                    selectElement.style.display = this.includeAllChatHistoryCheckbox?.checked ? 'inline-block' : 'none';
                }
            }

            clearAllData() {
                if (!confirm('האם אתה בטוח שברצונך למחוק את כל הנתונים השמורים, כולל היסטוריה והגדרות מ-localStorage?')) return;
                localStorage.removeItem('gemini-chats');
                localStorage.removeItem('gemini-api-key');
                localStorage.removeItem('gemini-model');
                localStorage.removeItem('chatHistoryEnabled');
                localStorage.removeItem('gemini-settings');
                localStorage.removeItem('gemini-system-prompt');
                localStorage.removeItem('gemini-system-prompt-template');
                localStorage.removeItem('luxury-mode');
                localStorage.removeItem('token-limit-disabled');
                localStorage.removeItem('user-profile-image');
                localStorage.removeItem('use-custom-profile-image');
                localStorage.removeItem('history-sidebar-collapsed');

                // איפוס משתני האפליקציה
                this.chats = {};
                this.currentChatId = null;
                this.apiKey = '';
                this.currentModel = 'gemini-2.5-flash-lite-preview-06-17';
                this.chatHistoryEnabled = true;
                this.settings = {
                    temperature: 0.7,
                    maxTokens: 4096,
                    topP: 0.95,
                    topK: 40,
                    streamResponse: true,
                    includeChatHistory: true,
                    includeAllChatHistory: false,
                    hideLoadingOverlay: false
                };
                this.systemPrompt = '';
                this.systemPromptTemplate = '';
                this.isLuxuryMode = false;
                this.tokenLimitDisabled = false;
                this.userProfileImage = null;
                this.files = [];

                // איפוס ממשק המשתמש
                this.resetToWelcomeScreen();
                this.loadSettings();
                this.loadTheme();
                this.loadLuxuryMode();
                this.renderChatHistory();

                this.showToast('כל הנתונים נמחקו בהצלחה', 'success');
            }

            exportHistoryAndSettings() {
                const storedImage = localStorage.getItem('user-profile-image');
                const useCustom = localStorage.getItem('use-custom-profile-image') === 'true';

                const data = {
                    chats: this.chats,
                    settings: {
                        apiKey: this.apiKey,
                        currentModel: this.currentModel,
                        chatHistoryEnabled: this.chatHistoryEnabled,
                        settings: this.settings,
                        systemPrompt: this.systemPrompt,
                        systemPromptTemplate: this.systemPromptTemplate,
                        isLuxuryMode: this.isLuxuryMode,
                        tokenLimitDisabled: this.tokenLimitDisabled,
                        userProfileImage: storedImage || null,
                        useCustomProfileImage: useCustom
                    }
                };

                const blob = new Blob([JSON.stringify(data, null, 2)], {
                    type: 'application/json'
                });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `gemini_clone_history_${new Date().toISOString().split('T')[0]}.json`;
                link.click();

                this.showToast('היסטוריה והגדרות יוצאו בהצלחה', 'success');
            }


            handleImport() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';

                input.onchange = (e) => {
                    const file = e.target.files[0];
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            const data = JSON.parse(event.target.result);
                            this.importHistoryAndSettings(data);
                        } catch (error) {
                            this.showToast('שגיאה בייבוא: קובץ לא תקין', 'error');
                            console.error('Import error:', error);
                        }
                    };
                    reader.onerror = () => {
                        this.showToast('שגיאה בקריאת הקובץ', 'error');
                    };
                    reader.readAsText(file);
                };

                input.click();
            }

            getPromptIcon(systemPrompt) {
                if (!systemPrompt) return {
                    iconHtml: '',
                    label: 'Gemini'
                };
                const promptLower = systemPrompt.toLowerCase();
                for (const [keyword, {
                        iconPath,
                        label
                    }] of Object.entries(this.iconMap)) {
                    if (promptLower.includes(keyword.toLowerCase())) {
                        console.log(`Match found for keyword: ${keyword}, iconPath: ${iconPath}`);
                        return {
                            iconHtml: `<img src="${iconPath}" alt="${keyword}" class="prompt-icon" style="width: 18px; height: 18px; margin-left: 5px; vertical-align: middle;">`,
                            label: label
                        };
                    }
                }
                console.log('No match found, returning default');
                return {
                    iconHtml: '',
                    label: 'Gemini'
                };
            }

            importHistoryAndSettings(data) {
                if (!data.chats || !data.settings) {
                    this.showToast('מבנה קובץ לא תקין', 'error');
                    return;
                }
                const mergedChats = { ...this.chats
                };

                Object.entries(data.chats).forEach(([importedChatId, newChat]) => {
                    let finalChatId = importedChatId;
                    let finalChat = { ...newChat
                    };

                    const currentChat = this.currentChatId && mergedChats[this.currentChatId];
                    const isCurrentChatConflict = currentChat && currentChat.title === newChat.title;

                    if (isCurrentChatConflict) {
                        const shouldOverwrite = confirm(
                            `צ'אט עם הכותרת "${newChat.title}" הוא הצ'אט הנוכחי. האם לדרוס אותו? (לחץ "אישור" לדריסה, "ביטול" לשמירת שניהם כשיחות נפרדות)`
                        );

                        if (shouldOverwrite) {
                            finalChatId = this.currentChatId;
                        } else {
                            finalChatId = Date.now().toString() + Math.random().toString(36).substr(2, 9);
                            let counter = 2;
                            let newTitle = `${newChat.title} (${counter})`;
                            while (Object.values(mergedChats).some(chat => chat.title === newTitle)) {
                                counter++;
                                newTitle = `${newChat.title} (${counter})`;
                            }
                            finalChat = { ...newChat,
                                title: newTitle
                            };
                        }
                    } else {
                        let counter = 2;
                        let newTitle = newChat.title;
                        while (Object.values(mergedChats).some(chat => chat.title === newTitle && chat !== currentChat)) {
                            newTitle = `${newChat.title} (${counter})`;
                            counter++;
                        }
                        finalChat = { ...newChat,
                            title: newTitle
                        };

                        if (mergedChats[importedChatId]) {
                            finalChatId = Date.now().toString() + Math.random().toString(36).substr(2, 9);
                        }
                    }

                    mergedChats[finalChatId] = finalChat;
                });

                this.chats = mergedChats;
                localStorage.setItem('gemini-chats', JSON.stringify(this.chats));

                this.apiKey = data.settings.apiKey || '';
                this.currentModel = data.settings.currentModel || 'gemini-2.5-flash-preview-05-20';
                this.chatHistoryEnabled = data.settings.chatHistoryEnabled !== false;
                this.settings = data.settings.settings || {
                    temperature: 0.7,
                    maxTokens: 4096,
                    topP: 0.95,
                    topK: 40,
                    streamResponse: true,
                    includeChatHistory: true,
                    hideLoadingOverlay: false
                };
                this.systemPrompt = data.settings.systemPrompt || '';
                this.systemPromptTemplate = data.settings.systemPromptTemplate || '';
                this.isLuxuryMode = data.settings.isLuxuryMode || false;
                this.tokenLimitDisabled = data.settings.tokenLimitDisabled || false;

                if (data.settings.userProfileImage) {
                    this.userProfileImage = data.settings.userProfileImage;
                    localStorage.setItem('user-profile-image', this.userProfileImage);
                }

                const useCustom = data.settings.useCustomProfileImage === true;
                localStorage.setItem('use-custom-profile-image', useCustom ? 'true' : 'false');
                this.userProfileImage = useCustom ? data.settings.userProfileImage : null;

                localStorage.setItem('gemini-api-key', this.apiKey);
                localStorage.setItem('gemini-model', this.currentModel);
                localStorage.setItem('chatHistoryEnabled', this.chatHistoryEnabled ? 'true' : 'false');
                localStorage.setItem('gemini-settings', JSON.stringify(this.settings));
                localStorage.setItem('gemini-system-prompt', this.systemPrompt);
                localStorage.setItem('gemini-system-prompt-template', this.systemPromptTemplate);
                localStorage.setItem('luxury-mode', this.isLuxuryMode ? 'true' : 'false');
                localStorage.setItem('token-limit-disabled', this.tokenLimitDisabled ? 'true' : 'false');

                this.loadSettings();
                this.renderChatHistory();
                this.loadTheme();
                this.loadLuxuryMode();

                if (this.currentChatId && this.chats[this.currentChatId]) {
                    this.loadChat(this.currentChatId);
                } else {
                    this.resetToWelcomeScreen();
                }
                this.renderMessages();
                this.showToast('היסטוריה והגדרות יובאו בהצלחה', 'success');
            }

            resetToWelcomeScreen() {
                this.currentChatId = null;
                this.chatMessages.innerHTML = '';
                this.chatMessages.classList.remove('active');
                this.chatMessages.style.display = 'none';
                this.welcomeScreen.style.display = 'flex';
                this.chatTitle.textContent = 'צ\'אט חדש';
                const editChatTitleBtn = document.getElementById('editChatTitleBtn');
                if (this.editChatTitleBtn) this.editChatTitleBtn.style.display = 'none';
                if (this.exportBtn) this.exportBtn.style.display = 'none';
                if (this.shareBtn) this.shareBtn.style.display = 'none';
                if (this.regenerateBtn) this.regenerateBtn.style.display = 'none';
                this.messageInput.value = '';
                this.updateCharCount();
                this.messageInput.style.height = 'auto';
                if (this.loadingOverlay) this.loadingOverlay.style.display = 'none';
                if (this.stopBtn) this.stopBtn.style.display = 'none';
                this.setLoading(false);
                this.stopFakeProgressBar();
                if (this.abortController) {
                    this.abortController.abort();
                    this.abortController = null;
                }
                this.renderChatHistory();
            }

            loadSettings() {
                this.geminiApiKey.value = this.apiKey;
                this.geminiModel.value = this.currentModel;
                this.hideLoadingOverlayCheckbox.checked = this.settings.hideLoadingOverlay !== false;
                if (this.includeAllChatHistoryCheckbox) {
                    this.includeAllChatHistoryCheckbox.checked = this.settings.includeAllChatHistory;
                }
                if (this.systemPromptInput) this.systemPromptInput.value = this.systemPrompt;
                if (this.systemPromptTemplateSelect) this.systemPromptTemplateSelect.value = this.systemPromptTemplate;

                const tokenLimitCheckbox = document.getElementById('toggleTokenLimit');
                const tokenLimitRow = document.getElementById('maxTokensRow');
                if (tokenLimitCheckbox && tokenLimitRow) {
                    tokenLimitCheckbox.checked = this.tokenLimitDisabled;

                    const applyTokenLimitState = () => {
                        if (tokenLimitCheckbox.checked) {
                            tokenLimitRow.classList.add('disabled');
                            tokenLimitRow.querySelectorAll('input, select, button').forEach(el => el.disabled = true);
                        } else {
                            tokenLimitRow.classList.remove('disabled');
                            tokenLimitRow.querySelectorAll('input, select, button').forEach(el => el.disabled = false);
                        }
                    };

                    applyTokenLimitState();

                    tokenLimitCheckbox.addEventListener('change', (e) => {
                        this.tokenLimitDisabled = e.target.checked;
                        this.saveSettings();
                        applyTokenLimitState();
                    });
                }

                const useCustom = localStorage.getItem('use-custom-profile-image') === 'true';
                this.userProfileImage = useCustom ? localStorage.getItem('user-profile-image') : null;


                const historyCheckbox = document.getElementById('enableChatHistory');
                if (historyCheckbox) {
                    historyCheckbox.checked = this.chatHistoryEnabled;

                    historyCheckbox.addEventListener('change', (e) => {
                        this.chatHistoryEnabled = e.target.checked;
                        this.saveSettings();
                    });
                }

                this.temperatureSlider.value = this.settings.temperature;
                this.maxTokensSlider.value = this.settings.maxTokens;
                this.topPSlider.value = this.settings.topP || 0.95;
                this.topKSlider.value = this.settings.topK || 40;
                this.streamResponseCheckbox.checked = this.settings.streamResponse !== false;
                this.includeChatHistoryCheckbox.checked = this.settings.includeChatHistory !== false;

                this.tempValue.textContent = this.settings.temperature;
                this.maxTokensValue.textContent = this.settings.maxTokens;
                this.topPValue.textContent = this.settings.topP || 0.95;
                this.topKValue.textContent = this.settings.topK || 40;
                this.modelInfo.textContent = this.getModelDisplayName(this.currentModel);

                if (this.apiKey) this.validateApiKey();
                this.renderChatHistory();
                this.toggleMaxMessagesVisibility();
            }

            updateHideLoadingOverlay(checked) {
                this.settings.hideLoadingOverlay = checked;
                this.saveSettings();
            }

            getModelDisplayName(modelId) {
                const models = {
                    'gemini-2.5-pro': 'gemini 2.5 pro',
                    'gemini-2.5-flash': 'gemini 2.5 flash',
                    'gemini-2.5-flash-lite-preview-06-17': 'Gemini Flash lite 2.5 (Preview)',
                    'gemini-2.5-flash-preview-05-20': 'Gemini Flash 2.5 (Preview)',
                    'gemini-2.0-flash-exp': 'Gemini 2.0 Flash Experimental',
                }
                return models[modelId] || modelId;
            }

            loadConfigScript() {
                return new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.src = 'config.js';
                    script.async = true;
                    script.onload = () => resolve();
                    script.onerror = () => reject(new Error('שגיאה בטעינת config.js'));

                    document.head.appendChild(script);
                });
            }

            async validateApiKey() {
                await this.loadConfigScript();
                if (!this.apiKey) return;
                try {
                    const response = await fetch(`https://${apiAddressToUse}.googleapis.com/v1/models?key=${this.apiKey}`);
                    if (response.ok) {
                        this.showApiStatus('API Key תקף ומחובר', 'success');
                    } else {
                        this.showApiStatus('API Key לא תקף', 'error');
                    }
                } catch (error) {
                    try {
                        const fallbackResponse = await fetch(`https://generativelanguage.googleapis.com/v1/models?key=${this.apiKey}`);
                        if (fallbackResponse.ok) {
                            this.showApiStatus('API Key תקף ומחובר', 'success');
                        } else {
                            this.showApiStatus('API Key לא תקף', 'error');
                            this.showToast('API Key לא תקף', 'error');
                        }
                    } catch (fallbackError) {
                        this.showApiStatus('שגיאה בבדיקת API Key', 'error');
                        this.showToast('שגיאה בבדיקת API Key', 'error');
                    }
                }
            }

            showApiStatus(message, type) {
                this.apiStatus.textContent = message;
                this.apiStatus.className = `api-status ${type}`;
                this.apiStatus.style.display = 'block';
            }

            saveApiKey(key) {
                this.apiKey = key;
                localStorage.setItem('gemini-api-key', key);
                if (key.trim()) {
                    this.validateApiKey();
                } else {
                    this.apiStatus.style.display = 'none';
                    this.showToast('מפתח ה-API הוסר', 'neutral');
                }
            }

            changeModel(model) {
                this.currentModel = model;
                localStorage.setItem('gemini-model', model);
                this.modelInfo.textContent = this.getModelDisplayName(model);
                this.showToast(`עבר למודל ${this.getModelDisplayName(model)}`, 'success');
            }

            changeSystemPromptTemplate(template) {
                this.systemPromptTemplate = template;
                localStorage.setItem('gemini-system-prompt-template', template);

                let promptText = '';
                switch (template) {
                    case 'expert':
                        promptText = 'פעל כמומחה בתחום ותן תשובות מעמיקות ומפורטות המבוססות על ידע מקצועי.';
                        break;
                    case 'creative':
                        promptText = 'היה יצירתי מאוד בתשובותיך, הצע רעיונות מקוריים וחדשניים, והשתמש בשפה עשירה וציורית.';
                        break;
                    case 'concise':
                        promptText = 'תן תשובות קצרות, תמציתיות וממוקדות. הימנע מפרטים מיותרים ושמור על בהירות.';
                        break;
                    case 'code':
                        promptText = 'פעל כמתכנת מקצועי. ספק קוד יעיל ומתועד היטב, כולל הסברים ברורים על הפתרון שבחרת.';
                        break;
                    case 'custom':
                        promptText = this.systemPrompt;
                        break;
                    default:
                        promptText = '';
                }

                this.systemPromptInput.value = promptText;
                this.saveSystemPrompt(promptText);

                if (template === 'custom') {
                    this.systemPromptInput.style.display = 'block';
                } else {
                    this.systemPromptInput.style.display = template ? 'none' : 'block';
                }
            }

            saveSystemPrompt(prompt) {
                if (this.pageConfig === 'chat-page') {
                    this.systemPrompt = prompt;
                    localStorage.setItem('gemini-system-prompt', prompt);
                }
            }

            updateTemperature(value) {
                this.settings.temperature = parseFloat(value);
                this.tempValue.textContent = value;
                this.saveSettings();
            }

            updateMaxTokens(value) {
                this.settings.maxTokens = parseInt(value);
                this.maxTokensValue.textContent = value;
                this.saveSettings();
            }

            updateTopP(value) {
                this.settings.topP = parseFloat(value);
                this.topPValue.textContent = value;
                this.saveSettings();
            }

            updateTopK(value) {
                this.settings.topK = parseInt(value);
                this.topKValue.textContent = value;
                this.saveSettings();
            }

            updateStreamResponse(checked) {
                this.settings.streamResponse = checked;
                this.saveSettings();
            }

            updateIncludeChatHistory(checked) {
                this.settings.includeChatHistory = checked;
                this.saveSettings();
            }

            saveSettings() {
                localStorage.setItem('gemini-settings', JSON.stringify(this.settings));
                localStorage.setItem('token-limit-disabled', this.tokenLimitDisabled ? 'true' : 'false');
                localStorage.setItem('chatHistoryEnabled', this.chatHistoryEnabled ? 'true' : 'false');
            }

            toggleSidebar() {
                this.sidebar.classList.toggle('collapsed');
                this.mainContent.classList.toggle('sidebar-collapsed');
                localStorage.setItem('sidebar-collapsed', this.sidebar.classList.contains('collapsed'));
            }

            toggleTheme() {
                const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                document.documentElement.setAttribute('data-theme', newTheme);
                localStorage.setItem('gemini-theme', newTheme);
                if (this.themeToggle) {
                    this.themeToggle.innerHTML = newTheme === 'dark' ?
                        '<span class="material-icons">light_mode</span> מצב בהיר' :
                        '<span class="material-icons">dark_mode</span> מצב כהה';
                }
                this.showToast(`עבר ל${newTheme === 'dark' ? 'מצב כהה' : 'מצב בהיר'}`, 'success');
            }

            toggleLuxuryMode() {
                this.isLuxuryMode = !this.isLuxuryMode;
                document.documentElement.setAttribute('data-luxury', this.isLuxuryMode ? 'true' : 'false');
                localStorage.setItem('luxury-mode', this.isLuxuryMode ? 'true' : 'false');
                this.showToast(this.isLuxuryMode ? 'מצב יוקרתי הופעל' : 'מצב יוקרתי כבוי', 'success');
            }

            loadTheme() {
                const savedTheme = localStorage.getItem('gemini-theme') || 'light';
                document.documentElement.setAttribute('data-theme', savedTheme);
                if (this.themeToggle) {
                    this.themeToggle.innerHTML = savedTheme === 'dark' ?
                        '<span class="material-icons">light_mode</span> מצב בהיר' :
                        '<span class="material-icons">dark_mode</span> מצב כהה';
                }
                const sidebarCollapsed = localStorage.getItem('sidebar-collapsed') === 'true';
                if (sidebarCollapsed) {
                    this.sidebar.classList.add('collapsed');
                    this.mainContent.classList.add('sidebar-collapsed');
                }
                const historySidebarCollapsed = localStorage.getItem('history-sidebar-collapsed') === 'true';
                if (historySidebarCollapsed && this.historySidebar) {
                    this.historySidebar.classList.add('collapsed');
                    this.mainContent.classList.add('history-collapsed');
                }
            }

            loadLuxuryMode() {
                document.documentElement.setAttribute('data-luxury', this.isLuxuryMode ? 'true' : 'false');
            }

            setupAutoResize() {
                this.messageInput.addEventListener('input', () => {
                    this.messageInput.style.height = 'auto';
                    this.messageInput.style.height = Math.min(this.messageInput.scrollHeight, 200) + 'px';
                });
            }

            initializeExportOptions() {
                document.querySelectorAll('#exportModal .export-option').forEach(option => {
                    option.addEventListener('click', () => {
                        const format = option.getAttribute('data-format');
                        const isAlreadySelected = option.classList.contains('selected');

                        if (isAlreadySelected) {
                            const includeTimestamps = document.querySelector('#includeTimestamps').checked;
                            const includeSystemPrompts = document.querySelector('#includeSystemPrompts').checked;
                            this.exportChat(format, includeTimestamps, includeSystemPrompts);
                            this.hideExportModal();
                        } else {
                            document.querySelectorAll('#exportModal .export-option').forEach(opt => {
                                opt.classList.remove('selected');
                            });
                            option.classList.add('selected');
                        }
                    });
                });

                const docxOption = document.querySelector('#exportModal .export-option[data-format="docx"]');
                if (docxOption) {
                    docxOption.classList.add('selected');
                }
            }

            showExportModal() {
                if (!this.currentChatId) {
                    this.showToast('אין צ\'אט לייצוא', 'error');
                    return;
                }

                document.querySelectorAll('#exportModal .export-option').forEach(opt => {
                    opt.classList.remove('selected');
                });
                const docxOption = document.querySelector('#exportModal .export-option[data-format="docx"]');
                if (docxOption) {
                    docxOption.classList.add('selected');
                } else {
                    document.querySelector('#exportModal .export-option[data-format="pdf"]').classList.add('selected');
                }

                this.exportModal.classList.add('visible');
            }

            hideExportModal() {
                this.exportModal.classList.remove('visible');
            }

            updateCharCount() {
                const length = this.messageInput.value.length;
                this.charCount.textContent = `${length}`;
                this.sendBtn.disabled = length === 0 || this.isLoading;
                if (length > 7000) {
                    this.charCount.style.color = 'var(--accent-color)';
                } else {
                    this.charCount.style.color = 'var(--text-tertiary)';
                }
            }

            handleKeyDown(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    if (!this.isLoading && this.messageInput.value.trim()) {
                        this.sendMessage();
                    }

                }
            }

            handleGlobalShortcuts(e) {
                if (e.ctrlKey && e.key === 'n') {
                    e.preventDefault();
                    this.startNewChat();
                } else if (e.ctrlKey && e.key === 'b') {
                    e.preventDefault();
                    this.toggleSidebar();
                } else if (e.ctrlKey && e.shiftKey && e.key === 'E') {
                    e.preventDefault();
                    this.showExportModal();
                }
            }

            startNewChat() {
                this.currentChatId = this.generateChatId();
                this.chats[this.currentChatId] = {
                    id: this.currentChatId,
                    title: 'צ\'אט חדש',
                    messages: [],
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    model: this.currentModel,
                    vote: null,
                    systemPrompt: this.systemPrompt
                };
                this.saveChatData();
                this.showChatInterface();
                this.renderChatHistory();
                this.updateChatTitle('צ\'אט חדש');
                this.messageInput.focus();
                this.files = [];
                this.renderFilePreview();
                const editChatTitleBtn = document.getElementById('editChatTitleBtn');
                if (editChatTitleBtn) {
                    editChatTitleBtn.style.display = 'none';
                }
            }

            showChatInterface() {
                this.welcomeScreen.style.display = 'none';
                this.chatMessages.classList.add('active');
                this.chatMessages.style.display = 'block';
                this.renderMessages();
            }

            updateChatTitle(title) {
                this.chatTitle.textContent = title;
                if (this.currentChatId && this.chats[this.currentChatId]) {
                    this.chats[this.currentChatId].title = title;
                    this.saveChatData();
                }
                const editChatTitleBtn = document.getElementById('editChatTitleBtn');
                if (editChatTitleBtn) {
                    editChatTitleBtn.style.display = title === 'צ\'אט חדש' ? 'none' : 'inline-block';
                }
            }

            async sendMessage() {
                if (!this.currentChatId) {
                    this.currentChatId = this.generateChatId();
                    this.chats[this.currentChatId] = {
                        id: this.currentChatId,
                        title: 'צ\'אט חדש',
                        messages: [],
                        systemPrompt: this.systemPrompt,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    };
                    this.showChatInterface();
                    if (this.exportBtn) this.exportBtn.style.display = 'inline-block';
                    if (this.shareBtn) this.shareBtn.style.display = 'inline-block';
                    if (this.regenerateBtn) this.regenerateBtn.style.display = 'inline-block';
                    if (this.editChatTitleBtn) this.editChatTitleBtn.style.display = 'none';
                }

                const message = this.messageInput.value.trim();
                console.log("sendMessage called at:", new Date().toISOString(), "Message:", message);
                if (!message && this.files.length === 0) {
                    console.log("sendMessage blocked: no message or files");
                    this.showToast('אנא הזן הודעה או צרף קובץ', 'error');
                    return;
                }
                if (this.isLoading) {
                    console.log("sendMessage blocked: loading");
                    this.showToast('נא להמתין עד לסיום התגובה הקודמת', 'error');
                    return;
                }
                if (!this.apiKey) {
                    this.showToast('אנא הזן API Key עבור Gemini', 'error');
                    return;
                }
                if (!this.currentChatId) {
                    this.startNewChat();
                }

                let messageFiles = [];
                try {
                    const supportedMimeTypes = ['image/png', 'image/jpeg', 'application/pdf', 'text/plain'];
                    messageFiles = await Promise.all(this.files.map(async file => {
                        if (!(file instanceof File || file instanceof Blob || (file.name && file.size && file.type && file.base64))) {
                            console.warn("Invalid file object:", file);
                            throw new Error('קובץ לא תקין: ' + (file.name || 'לא ידוע'));
                        }
                        if (file.base64) {
                            if (!/^[A-Za-z0-9+/=]+$/.test(file.base64)) {
                                console.warn("Invalid base64 format for file:", file.name);
                                throw new Error('פורמט Base64 לא תקין: ' + file.name);
                            }
                            return {
                                name: file.name,
                                size: file.size,
                                type: file.type,
                                base64: file.base64.startsWith('data:') ? file.base64.split(',')[1] : file.base64
                            };
                        }
                        const base64 = await this.readFileAsBase64(file);
                        return {
                            name: file.name,
                            size: file.size,
                            type: file.type,
                            base64: base64
                        };
                    }));
                } catch (error) {
                    this.showToast('שגיאה בהכנת קבצים: ' + error.message, 'error');
                    console.error('File Processing Error:', error);
                    return;
                }

                const userMessage = {
                    id: this.generateMessageId(),
                    role: 'user',
                    content: message,
                    timestamp: new Date().toISOString(),
                    files: messageFiles
                };

                this.chats[this.currentChatId].messages.push(userMessage);
                this.chats[this.currentChatId].updatedAt = new Date().toISOString();

                if (this.chats[this.currentChatId].messages.length === 1) {
                    const title = message.length > 20 ? message.substring(0, 20) + '...' : message || 'צ\'אט עם קבצים';
                    this.chats[this.currentChatId].title = title;
                    this.updateChatTitle(title);
                }

                this.files = [];
                this.filess = [];
                this.renderFilePreview();

                this.saveChatData();
                this.renderMessages();
                this.renderChatHistory();
                this.messageInput.value = '';
                this.updateCharCount();
                this.messageInput.style.height = 'auto';

                this.setLoading(true);
                this.startFakeProgressBar();
                this.showLoadingSteps();
                this.abortController = new AbortController();

                try {
                    let systemPrompt;
                    if (this.pageConfig === 'chat-page') {
                        systemPrompt = this.CONSTANT_SYSTEM_PROMPT + (this.systemPrompt ? '\n' + this.systemPrompt : '');
                    } else {
                        systemPrompt = this.systemPrompt;
                    }

                    const messages = [{
                        role: 'system',
                        content: systemPrompt
                    },
                        ...(this.settings.includeChatHistory ? this.chats[this.currentChatId].messages.map(msg => ({
                            role: msg.role,
                            content: msg.content,
                            files: msg.files || []
                        })) : [{
                            role: 'user',
                            content: message,
                            files: messageFiles
                        }])
                    ];

                    const response = await this.callGemini(message, this.abortController.signal, messageFiles);
                    const assistantMessage = {
                        id: this.generateMessageId(),
                        role: 'assistant',
                        content: response,
                        timestamp: new Date().toISOString(),
                        model: this.currentModel,
                        vote: null
                    };

                    this.chats[this.currentChatId].messages.push(assistantMessage);
                    this.chats[this.currentChatId].updatedAt = new Date().toISOString();
                    this.saveChatData();
                    this.renderMessages();
                } catch (error) {
                    if (error.name === 'AbortError') {
                        this.showToast('התגובה הופסקה', 'error');
                    } else if (error.message.includes('net::ERR_INTERNET_DISCONNECTED')) {
                        this.showToast('אין חיבור לאינטרנט. אנא בדוק את החיבור ונסה שוב', 'error');
                        console.error('Network Error:', error);
                    } else {
                        this.showToast('שגיאה בשליחת ההודעה: ' + error.message, 'error');
                        console.error('API Error:', error);
                    }
                } finally {
                    this.setLoading(false);
                    this.stopFakeProgressBar();
                }

                setTimeout(() => {
                    this.chatContainer.scrollTop = this.chatContainer.scrollHeight;
                }, 100);
            }

            startFakeProgressBar() {
                this.generationProgress = 0;
                this.updateProgressDisplay();

                const messageLength = this.messageInput.value.length;
                const complexity = messageLength > 500 ? 1.5 : 1;
                const totalUpdates = 20;
                const totalTime = Math.min(Math.max(messageLength * complexity * 15, 3000), 8000);
                const updateInterval = totalTime / totalUpdates;

                this.progressInterval = setInterval(() => {
                    if (this.generationProgress < 30) {
                        this.generationProgress += 3;
                    } else if (this.generationProgress < 60) {
                        this.generationProgress += 2;
                    } else if (this.generationProgress < 85) {
                        this.generationProgress += 1;
                    } else if (this.generationProgress < 95) {
                        this.generationProgress += 0.5;
                    }

                    this.generationProgress = Math.min(this.generationProgress, 95);
                    this.updateProgressDisplay();
                }, updateInterval);
            }

            stopFakeProgressBar() {
                clearInterval(this.progressInterval);
                this.generationProgress = 100;
                this.updateProgressDisplay();
            }

            updateProgressDisplay() {
                if (this.loadingProgress) {
                    this.loadingProgress.textContent = `${Math.round(this.generationProgress)}%`;
                }
            }

            showLoadingSteps() {
                const steps = document.querySelectorAll('.step');
                let currentStep = 0;
                const stepMessages = [
                    'מנתח את השאלה...',
                    'מחפש מידע רלוונטי...',
                    'מכין תשובה מקיפה...'
                ];

                const interval = setInterval(() => {
                    if (currentStep > 0) steps[currentStep - 1].classList.remove('active');
                    if (currentStep < steps.length) {
                        steps[currentStep].classList.add('active');
                        this.loadingMessage.textContent = stepMessages[currentStep];
                        currentStep++;
                    } else {
                        clearInterval(interval);
                    }
                }, 1000);

                this.loadingInterval = interval;
            }

            async callGemini(message, signal, files = []) {
                if (!this.apiKey) {
                    throw new Error('מפתח API לא מוגדר');
                }

                const url = `https://generativelanguage.googleapis.com/v1beta/models/${this.currentModel}:generateContent?key=${this.apiKey}`;

                const estimateTokens = (text) => {
                    const words = text.split(/\s+/).length;
                    const chars = text.length;
                    return Math.ceil((words * 0.75) + (chars / 6));
                };

                let conversationHistory = [];
                let currentChatMessages = [];
                let wasHistoryTrimmed = false;

                if (this.settings.includeAllChatHistory) {
                    Object.values(this.chats)
                        .filter(chat => chat.messages && chat.messages.length > 0)
                        .sort((a, b) => new Date(a.messages[0]?.timestamp || 0) - new Date(b.messages[0]?.timestamp || 0))
                        .forEach(chat => {
                            if (chat.id === this.currentChatId) {
                                currentChatMessages = [...chat.messages];
                            } else {
                                conversationHistory.push(...chat.messages.map(msg => ({
                                    ...msg,
                                    chatId: chat.id
                                })));
                                conversationHistory.push({
                                    id: "separator_" + chat.id,
                                    role: "system",
                                    content: "[END_CHAT: " + (chat.title || "צ'אט ללא כותרת") + "]",
                                    timestamp: chat.messages[chat.messages.length - 1]?.timestamp || new Date().toISOString(),
                                    chatId: chat.id
                                });
                            }
                        });
                    if (currentChatMessages.length > 0) {
                        conversationHistory.push(...currentChatMessages.slice(0, -1).map(msg => ({
                            ...msg,
                            chatId: this.currentChatId
                        })));
                    }

                    const originalLength = conversationHistory.length;
                    if (this.settings.maxMessages && [20, 50, 100, 200].includes(this.settings.maxMessages)) {
                        conversationHistory = conversationHistory.slice(-this.settings.maxMessages);
                        if (conversationHistory.length < originalLength) {
                            wasHistoryTrimmed = true;
                            console.log(`History trimmed due to maxMessages: ${this.settings.maxMessages}`);
                        }
                    }
                } else if (this.settings.includeChatHistory) {
                    const currentChat = this.chats[this.currentChatId];
                    if (currentChat && currentChat.messages) {
                        currentChatMessages = [...currentChat.messages];
                        conversationHistory = currentChatMessages.slice(0, -1).map(msg => ({
                            ...msg,
                            chatId: this.currentChatId
                        }));

                        const originalLength = conversationHistory.length;
                        const originalTokens = conversationHistory.reduce((sum, msg) => sum + estimateTokens(msg.content), 0);

                        if (this.settings.maxTokens && !this.tokenLimitDisabled) {
                            let totalTokens = originalTokens;
                            const maxHistoryTokens = Math.floor(this.settings.maxTokens * 5 / 6);
                            console.log(`Initial tokens: ${totalTokens}, Max tokens: ${maxHistoryTokens}`);

                            while (totalTokens > maxHistoryTokens && conversationHistory.length > 0) {
                                const removedMessage = conversationHistory.shift();
                                totalTokens -= estimateTokens(removedMessage.content);
                                wasHistoryTrimmed = true;
                            }

                            if (wasHistoryTrimmed) {
                                console.log(`History trimmed due to tokens. Remaining tokens: ${totalTokens}`);
                            }
                        }

                        if (this.settings.maxMessages && [20, 50, 100, 200].includes(this.settings.maxMessages)) {
                            conversationHistory = conversationHistory.slice(-this.settings.maxMessages);
                            if (conversationHistory.length < originalLength) {
                                wasHistoryTrimmed = true;
                                console.log(`History trimmed due to maxMessages: ${this.settings.maxMessages}`);
                            }
                        }
                    }
                }

                if (wasHistoryTrimmed) {
                    if (this.settings.maxMessages && [20, 50, 100, 200].includes(this.settings.maxMessages)) {
                        this.showToast("ההיסטוריה קוצרה ל-" + this.settings.maxMessages + " הודעות", "neutral");
                    }
                    if (this.settings.maxTokens && !this.tokenLimitDisabled) {
                        this.showToast("ההיסטוריה קוצרה בשל מגבלת הטוקנים", "neutral");
                    }
                }

                const messages = conversationHistory.map(msg => ({
                    role: msg.role === "assistant" ? "model" : "user",
                    parts: [{
                        text: msg.content
                    },
                        ...(msg.files || []).map(file => ({
                            inlineData: {
                                mimeType: file.type,
                                data: file.base64
                            }
                        }))
                    ]
                }));

                let systemPromptText = this.chats[this.currentChatId]?.systemPrompt || '';
                if (this.pageConfig === 'chat-page') {
                    systemPromptText = this.CONSTANT_SYSTEM_PROMPT + (systemPromptText ? '\n' + systemPromptText : '');
                }

                messages.unshift({
                    role: "user",
                    parts: [{
                        text: "הנחיית מערכת: " + systemPromptText
                    }]
                });

                const fileParts = files.length > 0 ? files.map(file => ({
                    inlineData: {
                        mimeType: file.type,
                        data: file.base64
                    }
                })) : [];

                messages.push({
                    role: "user",
                    parts: [{
                        text: message
                    }, ...fileParts]
                });

                try {
                    const response = await fetch(url, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({
                            contents: messages,
                            generationConfig: {
                                temperature: this.settings.temperature,
                                topK: this.settings.topK,
                                topP: this.settings.topP,
                                maxOutputTokens: this.tokenLimitDisabled ? undefined : this.settings.maxTokens
                            },
                            safetySettings: [{
                                category: "HARM_CATEGORY_HARASSMENT",
                                threshold: "BLOCK_MEDIUM_AND_ABOVE"
                            }, {
                                category: "HARM_CATEGORY_HATE_SPEECH",
                                threshold: "BLOCK_MEDIUM_AND_ABOVE"
                            }]
                        }),
                        signal
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error?.message || "Gemini API Error");
                    }

                    const data = await response.json();
                    if (!data.candidates || !data.candidates[0] || !data.candidates[0].content) {
                        throw new Error("תגובה לא תקינה מ-Gemini API");
                    }

                    return data.candidates[0].content.parts[0].text;
                } catch (error) {
                    if (error.message.includes('net::ERR_INTERNET_DISCONNECTED')) {
                        throw new Error('אין חיבור לאינטרנט');
                    }
                    throw error;
                }
            }

            abortGeneration() {
                if (this.abortController) {
                    this.abortController.abort();
                    this.abortController = null;
                    this.stopFakeProgressBar();
                    this.setLoading(false);
                }
            }

            renderMessages() {
                if (!this.currentChatId || !this.chats[this.currentChatId]) {
                    this.chatMessages.innerHTML = '';
                    return;
                }

                const messages = this.chats[this.currentChatId].messages;
                let messagesHTML = messages.map(message => this.createMessageHTML(message)).join('');

                if (this.isLoading && this.settings.hideLoadingOverlay) {
                    messagesHTML += `
                <div class="animated-dots">
                    <span class="dot"></span>
                    <span class="dot"></span>
                    <span class="dot"></span>
               
                    <button class="stop-btn" title="עצור">
                        <span class="material-icons">stop_circle</span>
                    </button>
                </div>`;
                }

                this.chatMessages.innerHTML = messagesHTML;
                this.bindMessageActions();
                Prism.highlightAll();

                if (this.isLoading && this.settings.hideLoadingOverlay) {
                    const stopBtn = this.chatMessages.querySelector('.animated-dots .stop-btn');
                    if (stopBtn) {
                        stopBtn.addEventListener('click', () => this.abortGeneration());
                    }
                }

                setTimeout(() => {
                    this.chatContainer.scrollTop = this.chatContainer.scrollHeight;
                }, 0);
            }

            createMessageHTML(message) {
                const isUser = message.role === 'user';
                const time = new Date(message.timestamp).toLocaleTimeString('he-IL', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                const systemPrompt = this.chats[this.currentChatId]?.systemPrompt || '';
                const promptIcon = this.getPromptIcon(systemPrompt);
                const avatar = isUser ?
                    this.userProfileImage ?
                    `<img src="data:image/*;base64,${this.userProfileImage}" alt="משתמש" class="user-avatar">` :
                    '<span>אתה</span>' :
                    promptIcon.iconHtml ?
                    `<img src="${promptIcon.iconHtml.match(/src="([^"]+)"/)?.[1]}" alt="עוזר" class="assistant-avatar">` :
                    '<span class="material-icons assistant-icon">auto_awesome</span>';
                const senderName = isUser ? 'אתה' : promptIcon.label;

                let filesHtml = '';
                if (message.files && message.files.length) {
                    const images = message.files.filter(f => f.type.startsWith('image/'));
                    const otherFiles = message.files.filter(f => !f.type.startsWith('image/'));

                    filesHtml = '';

                    if (images.length) {
                        filesHtml += `
                    <div class="file-preview-list images-only">
                        ${images.map(f => `
                            <div class="image-thumbnail" title="${f.name}">
                                <img src="data:${f.type};base64,${f.base64}" 
                                     alt="${f.name}" 
                                     class="chat-thumbnail"
                                     onclick="showLightbox('data:${f.type};base64,${f.base64}')">
                                <div class="image-name">${f.name}</div>
                            </div>
                        `).join('')}
                    </div>`;
                    }

                    if (otherFiles.length) {
                        filesHtml += `
                    <div class="file-preview-list other-files">
                        ${otherFiles.map(f => `
                            <div class="file-preview">
                                <span class="material-icons">${this.getFileIcon(f)}</span>
                                <span title="${f.name}">${f.name.length > 18 ? f.name.slice(0,15)+'...' : f.name}</span>
                                <span>(${this.formatFileSize(f.size)})</span>
                            </div>
                        `).join('')}
                    </div>`;
                    }
                }

                return `
            <div class="message ${message.role}" data-message-id="${message.id}">
                <div class="message-header">
                    <div class="message-avatar">${avatar}</div>
                    <span class="message-sender">${senderName}</span>
                    <span class="message-time">${time}</span>
                    ${message.model ? `<span class="message-model">${this.getModelDisplayName(message.model)}</span>` : ''}
                </div>
                <div class="message-content">
                    ${this.formatMessageContent(message.content)}
                    ${filesHtml}
                </div>
                <div class="message-actions">
                    ${!isUser ? `
                        <button class="action-btn-small copy-btn" title="העתק">
                            <span class="material-icons">content_copy</span>
                        </button>
                        <button class="action-btn-small delete-btn" title="מחק">
                            <span class="material-icons">delete</span>
                        </button>
                        <button class="action-btn-small retry-btn" title="ענה מחדש">
                            <span class="material-icons">refresh</span>
                        </button>
                    <div class="likes-dislikes" style="display:inline-flex; gap:6px; align-items:center; margin-right:10px;">
                        <button class="like-btn" title="אהבתי">👍</button>
                        <button class="dislike-btn" title="לא אהבתי">👎</button>
                    </div>
                    ` : `
                        <button class="action-btn-small edit-btn" title="ערוך">
                            <span class="material-icons">edit</span>
                        </button>
                        <button class="action-btn-small copy-btn" title="העתק">
                            <span class="material-icons">content_copy</span>
                        </button>
                        <button class="action-btn-small delete-btn" title="מחק">
                            <span class="material-icons">delete</span>
                        </button>
                    `}
                </div>
            </div>
        `;
            }

            formatMessageContent(content) {
                let formatted = content;

                formatted = formatted.replace(/```(\w+)?\n([\s\S]*?)```/g, (match, lang, code) => {
                    lang = lang || 'javascript';
                    const escapedCode = code
                        .replace(/&/g, '&amp;')
                        .replace(/</g, '&lt;')
                        .replace(/>/g, '&gt;')
                        .replace(/"/g, '&quot;')
                        .replace(/'/g, '&#39;');
                    return `<pre class="code-block"><code class="language-${lang}">${escapedCode}</code>
                <button class="copy-code-btn" title="העתק קוד"><span class="material-icons">content_copy</span></button>
            </pre>`;
                });

                formatted = formatted.replace(/`([^`]+)`/g, '<code>$1</code>');
                formatted = formatted.replace(/\[([^\]]+)\]\((https?:\/\/[^\)]+)\)/g, '<a href="$2" target="_blank">$1</a>');
                formatted = formatted.replace(/^### (.*)$/gm, '<h3>$1</h3>');
                formatted = formatted.replace(/^## (.*)$/gm, '<h2>$1</h2>');
                formatted = formatted.replace(/^# (.*)$/gm, '<h1>$1</h1>');
                formatted = formatted.replace(/^- (.+)$/gm, '<li>$1</li>');
                formatted = formatted.replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>');
                formatted = formatted.replace(/^\d+\. (.+)$/gm, '<li>$1</li>');
                formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
                formatted = formatted.replace(/__(.*?)__/g, '<u>$1</u>');

                formatted = formatted.replace(/((?:\|.+\|(?:\n|$))+)/g, (table) => {
                    const rows = table.trim().split('\n');
                    let tableHtml = '<table>';
                    if (rows.length > 1 && rows[1].replace(/[^|]/g, '') === rows[1]) {
                        tableHtml += '<thead><tr>' +
                            rows[0].split('|').filter(Boolean).map(cell => `<th>${cell.trim()}</th>`).join('') +
                            '</tr></thead><tbody>';
                        for (let i = 2; i < rows.length; i++) {
                            tableHtml += '<tr>' +
                                rows[i].split('|').filter(Boolean).map(cell => `<td>${cell.trim()}</td>`).join('') +
                                '</tr>';
                        }
                        tableHtml += '</tbody>';
                    } else {
                        for (const row of rows) {
                            tableHtml += '<tr>' +
                                row.split('|').filter(Boolean).map(cell => `<td>${cell.trim()}</td>`).join('') +
                                '</tr>';
                        }
                    }
                    return tableHtml + '</table>';
                });

                // שמירת code blocks זמנית
                const tempCodeBlocks = [];
                formatted = formatted.replace(/<pre class="code-block">[\s\S]*?<\/pre>/g, (match) => {
                    const index = tempCodeBlocks.length;
                    tempCodeBlocks.push(match);
                    return `__TEMP_CODE_${index}__`;
                });

                // המרת מעברי שורות ל-<br> רק מחוץ ל-code blocks
                formatted = formatted.replace(/\n/g, '<br>');

                // החזרת code blocks
                tempCodeBlocks.forEach((block, index) => {
                    formatted = formatted.replace(`__TEMP_CODE_${index}__`, block);
                });

                return formatted;
            }

            retryMessage(messageId) {
                if (!this.currentChatId || this.isLoading) {
                    this.showToast('לא ניתן לנסות מחדש כרגע', 'error');
                    return;
                }

                const messages = this.chats[this.currentChatId].messages;
                const messageIndex = messages.findIndex(msg => msg.id === messageId);

                if (messageIndex === -1 || messages[messageIndex].role !== 'assistant') {
                    this.showToast('לא ניתן לנסות מחדש הודעה זו', 'error');
                    return;
                }

                let userMessageIndex = messageIndex - 1;
                if (userMessageIndex < 0 || messages[userMessageIndex].role !== 'user') {
                    this.showToast('לא נמצאה הודעת משתמש קודמת', 'error');
                    return;
                }

                const userMessage = messages[userMessageIndex];

                this.files = [];
                if (userMessage.files && userMessage.files.length > 0) {
                    try {
                        this.files = userMessage.files.filter(file => {
                            if (!file.base64 || !/^[A-Za-z0-9+/=]+$/.test(file.base64)) {
                                console.warn('Invalid base64 for file:', file.name);
                                this.showToast(`קובץ לא תקין: ${file.name}`, 'error');
                                return false;
                            }
                            return true;
                        }).map(file => ({
                            name: file.name,
                            size: file.size,
                            type: file.type,
                            base64: file.base64.startsWith('data:') ? file.base64.split(',')[1] : file.base64
                        }));
                    } catch (error) {
                        this.showToast('שגיאה בטעינת קבצים: ' + error.message, 'error');
                        console.error('File Processing Error:', error);
                        return;
                    }
                }

                this.renderFilePreview();
                this.chats[this.currentChatId].messages = messages.slice(0, userMessageIndex + 1);
                this.chats[this.currentChatId].updatedAt = new Date().toISOString();
                this.saveChatData();
                this.renderMessages();
                this.setLoading(true);
                this.startFakeProgressBar();
                this.showLoadingSteps();
                this.abortController = new AbortController();

                this.callGemini(userMessage.content, this.abortController.signal, this.files)
                    .then(response => {
                        const assistantMessage = {
                            id: this.generateMessageId(),
                            role: 'assistant',
                            content: response,
                            timestamp: new Date().toISOString(),
                            model: this.currentModel,
                            vote: null
                        };

                        this.chats[this.currentChatId].messages.push(assistantMessage);
                        this.chats[this.currentChatId].updatedAt = new Date().toISOString();
                        this.saveChatData();
                        this.renderMessages();

                        setTimeout(() => {
                            this.chatContainer.scrollTop = this.chatContainer.scrollHeight;
                        }, 100);
                    })
                    .catch(error => {
                        if (error.name === 'AbortError') {
                            this.showToast('התגובה הופסקה', 'error');
                        } else if (error.message.includes('net::ERR_INTERNET_DISCONNECTED')) {
                            this.showToast('אין חיבור לאינטרנט. אנא בדוק את החיבור ונסה שוב', 'error');
                            console.error('Network Error:', error);
                        } else {
                            this.showToast('שגיאה בניסיון מחדש: ' + error.message, 'error');
                            console.error('API Error:', error);
                        }
                    })
                    .finally(() => {
                        this.setLoading(false);
                        this.stopFakeProgressBar();
                        this.files = [];
                        this.renderFilePreview();
                    });
            }

            bindMessageActions() {
                document.querySelectorAll('.copy-code-btn').forEach(btn => {
                    btn.onclick = (e) => {
                        const code = btn.parentElement.querySelector('code').innerText;
                        navigator.clipboard.writeText(code);
                        this.showToast('הקוד הועתק', 'success');
                        e.stopPropagation();
                    };
                });

                document.querySelectorAll('.retry-btn').forEach(btn => {
                    btn.onclick = (e) => {
                        const msgEl = btn.closest('.message');
                        const messageId = msgEl.getAttribute('data-message-id');
                        this.retryMessage(messageId);
                        e.stopPropagation();
                    };
                });

                document.querySelectorAll('.copy-btn').forEach(btn => {
                    btn.onclick = (e) => {
                        const msg = btn.closest('.message').querySelector('.message-content').innerText;
                        navigator.clipboard.writeText(msg);
                        this.showToast('הועתק ללוח', 'success');
                        e.stopPropagation();
                    };
                });

                document.querySelectorAll('.share-btn').forEach(btn => {
                    btn.onclick = (e) => {
                        const msg = btn.closest('.message').querySelector('.message-content').innerText;
                        navigator.clipboard.writeText(msg);
                        this.showToast('ההודעה הועתקה לשיתוף', 'success');
                        e.stopPropagation();
                    };
                });

                document.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.onclick = (e) => {
                        const msgEl = btn.closest('.message');
                        const messageId = msgEl.getAttribute('data-message-id');
                        this.deleteMessage(messageId);
                        e.stopPropagation();
                    };
                });

                document.querySelectorAll('.edit-btn').forEach(btn => {
                    btn.onclick = (e) => {
                        const msgEl = btn.closest('.message');
                        const messageId = msgEl.getAttribute('data-message-id');
                        this.editMessage(messageId);
                        e.stopPropagation();
                    };
                });

                document.querySelectorAll('.message').forEach(messageEl => {
                    const likeBtn = messageEl.querySelector('.like-btn');
                    const dislikeBtn = messageEl.querySelector('.dislike-btn');
                    const likeCountSpan = messageEl.querySelector('.like-count');
                    const dislikeCountSpan = messageEl.querySelector('.dislike-count');

                    if (likeBtn && dislikeBtn && likeCountSpan && dislikeCountSpan) {
                        let likeCount = 0;
                        let dislikeCount = 0;

                        likeBtn.addEventListener('click', () => {
                            likeCount++;
                            likeCountSpan.textContent = likeCount;
                        });

                        dislikeBtn.addEventListener('click', () => {
                            dislikeCount++;
                            dislikeCountSpan.textContent = dislikeCount;
                        });
                    }
                });
                document.querySelectorAll('.likes-dislikes').forEach(container => {
                    const likeBtn = container.querySelector('.like-btn');
                    const dislikeBtn = container.querySelector('.dislike-btn');
                    const messageEl = container.closest('.message');
                    if (!messageEl) return;

                    const messageId = messageEl.getAttribute('data-message-id');
                    const chat = this.chats[this.currentChatId];
                    if (!chat || !chat.messages) return;

                    const message = chat.messages.find(m => m.id === messageId);
                    if (!message) return;

                    const systemPrompt = chat.systemPrompt || '';
                    const {
                        likeMessage,
                        dislikeMessage,
                        feedbackAsAlert
                    } = this.getFeedbackMessages(systemPrompt);

                    const updateButtons = () => {
                        likeBtn.classList.toggle('active', message.vote === 'like');
                        dislikeBtn.classList.toggle('active', message.vote === 'dislike');
                    };

                    likeBtn.addEventListener('click', () => {
                        const wasSelected = message.vote === 'like';
                        message.vote = wasSelected ? null : 'like';
                        this.saveChatData();
                        if (!wasSelected) {
                            if (feedbackAsAlert) {
                                alert(likeMessage);
                            } else {
                                this.showToast(likeMessage, 'success');
                            }
                        }
                        updateButtons();
                    });

                    dislikeBtn.addEventListener('click', () => {
                        const wasSelected = message.vote === 'dislike';
                        message.vote = wasSelected ? null : 'dislike';
                        this.saveChatData();
                        if (!wasSelected) {
                            if (feedbackAsAlert) {
                                alert(dislikeMessage);
                            } else {
                                this.showToast(dislikeMessage, 'neutral');
                            }
                        }
                        updateButtons();
                    });

                    updateButtons();
                });
            }

            editMessage(messageId) {
                if (!this.currentChatId) return;

                const messages = this.chats[this.currentChatId].messages;
                const messageIndex = messages.findIndex(msg => msg.id === messageId);

                if (messageIndex === -1 || messages[messageIndex].role !== 'user') {
                    this.showToast('לא ניתן לערוך הודעה זו', 'error');
                    return;
                }

                const message = messages[messageIndex];

                this.messageInput.value = message.content;
                this.updateCharCount();
                this.messageInput.focus();

                this.files = (message.files || []).filter(file => file.base64).map(file => ({
                    name: file.name,
                    size: file.size,
                    type: file.type,
                    base64: file.base64
                }));
                this.filess = this.files;
                this.renderFilePreview();

                this.chats[this.currentChatId].messages = messages.slice(0, messageIndex);
                this.chats[this.currentChatId].updatedAt = new Date().toISOString();
                this.saveChatData();
                this.renderMessages();
                this.showToast('ערוך את ההודעה ושלח שוב', 'success');
            }

            renderChatHistory() {
                if (this.searchQuery) {
                    this.filterChatHistory();
                    return;
                }
                const chatArray = Object.values(this.chats);
                const historyHeader = document.querySelector('.history-header');
                const searchWrapper = document.querySelector('.search-wrapper');
                console.log("renderChatHistory called at:", new Date().toISOString());

                if (chatArray.length === 0) {
                    if (historyHeader) historyHeader.style.display = 'none';
                    if (searchWrapper) searchWrapper.style.display = 'none';
                    this.chatHistory.innerHTML = `<div class="no-results">אין היסטוריה להצגה</div>`;
                    return;
                }

                if (historyHeader) historyHeader.style.display = 'flex';
                if (searchWrapper) searchWrapper.style.display = 'block';

                const sortedChats = chatArray.sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt));
                this.chatHistory.innerHTML = sortedChats.map(chat => {
                    return `
                <div class="history-item ${chat.id === this.currentChatId ? 'active' : ''}" data-chat-id="${chat.id}">
                    <div class="history-item-title">${this.getPromptIcon(chat.systemPrompt).iconHtml}${chat.title}</div>
                    <div class="history-item-preview">${this.getChatSummary(chat)}</div>
                    <button class="delete-chat-btn" data-chat-id="${chat.id}" title="מחק צ'אט">
                        <span class="material-icons">delete</span>
                    </button>
                </div>
            `;
                }).join('');

                this.bindChatHistoryEvents();
            }



            getChatSummary(chat) {
                if (!chat.messages || chat.messages.length === 0) return 'שיחה חדשה';
                const firstUserMsg = chat.messages.find(m => m.role === 'user');
                if (firstUserMsg) {
                    let summary = firstUserMsg.content.split('\n')[0];
                    if (summary.length > 40) summary = summary.substring(0, 40) + '...';
                    return summary;
                }
                return chat.title;
            }

            loadChat(chatId) {
                this.currentChatId = chatId;
                const chat = this.chats[chatId];
                this.showChatInterface();
                this.updateChatTitle(chat.title);
                this.renderChatHistory();
                this.files = [];
                const editChatTitleBtn = document.getElementById('editChatTitleBtn');
                if (editChatTitleBtn) {
                    editChatTitleBtn.style.display = chat.title === 'צ\'אט חדש' ? 'none' : 'inline-block';
                }
                if (this.exportBtn) {
                    this.exportBtn.style.display = 'inline-block';
                }
                if (this.shareBtn) {
                    this.shareBtn.style.display = 'inline-block';
                }
                if (this.regenerateBtn) {
                    this.regenerateBtn.style.display = 'inline-block';
                }
            }

            deleteChat(chatId) {
                if (!confirm('האם אתה בטוח שברצונך למחוק את הצ\'אט הזה?')) {
                    return;
                }

                const deletedChat = this.chats[chatId];
                if (!deletedChat) {
                    console.warn('Chat not found:', chatId);
                    this.showToast('צ\'אט לא נמצא', 'error');
                    return;
                }
                const currentChatId = this.currentChatId;

                delete this.chats[chatId];
                this.saveChatData();

                if (chatId === currentChatId) {
                    this.resetToWelcomeScreen();
                    this.currentChatId = null;
                    this.welcomeScreen.style.display = 'flex';
                    this.chatMessages.style.display = 'none';
                    this.chatMessages.classList.remove('active');
                    this.updateChatTitle('צ\'אט חדש');
                }

                this.renderChatHistory();

                this.showToast('הצ\'אט נמחק', 'success', {
                    action: {
                        text: 'בטל',
                        callback: () => {
                            console.log('Restoring chat:', chatId);
                            this.chats[chatId] = deletedChat;
                            this.saveChatData();
                            this.renderChatHistory();
                            if (chatId === currentChatId) {
                                this.loadChat(chatId);
                            }
                            this.showToast('הצ\'אט שוחזר', 'success');
                        }
                    }
                });
            }

            clearHistory() {
                if (confirm('האם אתה בטוח שברצונך למחוק את כל ההיסטוריה?')) {
                    this.chats = {};
                    this.currentChatId = null;
                    localStorage.removeItem('gemini-chats');
                    this.renderChatHistory();
                    this.welcomeScreen.style.display = 'flex';
                    this.chatMessages.style.display = 'none';
                    this.chatMessages.classList.remove('active');
                    this.updateChatTitle('צ\'אט חדש');
                    this.showToast('ההיסטוריה נמחקה', 'success');
                }
            }

            shareChat() {
                if (!this.currentChatId) {
                    this.showToast('אין צ\'אט להעתקה', 'error');
                    return;
                }

                const chat = this.chats[this.currentChatId];
                const chatText = chat.messages.map(msg =>
                    `${msg.role === 'user' ? 'אתה' : 'Gemini'}: ${msg.content}`
                ).join('\n\n');

                navigator.clipboard.writeText(chatText).then(() => {
                    this.showToast('הצ\'אט הועתק ללוח', 'success');
                });
            }

            exportChat(format = 'pdf', includeTimestamps = true, includeSystemPrompts = false) {
                if (!this.currentChatId) {
                    this.showToast('אין צ\'אט לייצוא', 'error');
                    return;
                }

                const chat = this.chats[this.currentChatId];

                switch (format) {
                    case 'pdf':
                        this.exportToPdf(chat, includeTimestamps, includeSystemPrompts);
                        break;
                    case 'docx':
                        this.exportToDocx(chat, includeTimestamps, includeSystemPrompts);
                        break;
                    case 'txt':
                        this.exportToText(chat, includeTimestamps, includeSystemPrompts);
                        break;
                    default:
                        this.exportToPdf(chat, includeTimestamps, includeSystemPrompts);
                }
            }

            cleanFileName(name) {
                return name.replace(/[<>:"\/\\|?*\x00-\x1F]/g, '_').trim();
            }

            exportToPdf(chat, includeTimestamps, includeSystemPrompts) {
                const {
                    jsPDF
                } = window.jspdf;
                const doc = new jsPDF();
                doc.setFont('Helvetica', 'normal');
                doc.setFontSize(20);
                doc.text(chat.title, 190, 20, {
                    align: 'right'
                });
                doc.setFontSize(12);
                let y = 40;
                if (includeSystemPrompts && chat.systemPrompt && this.isSystemPromptAllowed(chat.systemPrompt)) {
                    doc.setFont('Helvetica', 'italic');
                    doc.text('System Prompt:', 190, y, {
                        align: 'right'
                    });
                    y += 7;
                    doc.setFont('Helvetica', 'normal');

                    const systemPromptLines = doc.splitTextToSize(chat.systemPrompt, 170);
                    doc.text(systemPromptLines, 190, y, {
                        align: 'right'
                    });
                    y += systemPromptLines.length * 7 + 10;
                }
                for (const msg of chat.messages) {
                    const role = msg.role === 'user' ? 'אתה' : this.getPromptIcon(chat.systemPrompt).label;

                    doc.setFont('Helvetica', 'bold');
                    doc.text(role, 190, y, {
                        align: 'right'
                    });

                    if (includeTimestamps) {
                        const time = new Date(msg.timestamp).toLocaleString('he-IL');
                        doc.setFontSize(8);
                        doc.setTextColor(100, 100, 100);
                        doc.text(time, 20, y);
                        doc.setFontSize(12);
                        doc.setTextColor(0, 0, 0);
                    }

                    y += 7;
                    const content = msg.content.replace(/```[\s\S]*?```/g, '[CODE BLOCK]')
                        .replace(/<[^>]*>/g, '')
                        .replace(/\!\[.*?\]\(.*?\)/g, '[IMAGE]')
                        .replace(/\[.*?\]\(.*?\)/g, '[LINK]');

                    const contentLines = doc.splitTextToSize(content, 170);

                    if (y + contentLines.length * 7 > 280) {
                        doc.addPage();
                        y = 20;
                    }

                    doc.setFont('Helvetica', 'normal');
                    doc.text(contentLines, 190, y, {
                        align: 'right'
                    });
                    y += contentLines.length * 7 + 10;

                    if (y > 280) {
                        doc.addPage();
                        y = 20;
                    }
                }

                const date = new Date().toLocaleString('he-IL');
                doc.setFontSize(8);
                doc.setTextColor(100, 100, 100);
                doc.text(`יוצא ב: ${date}`, 20, 290);
                doc.text('Gemini Clone', 190, 290, {
                    align: 'right'
                });
                const cleanTitle = this.cleanFileName(chat.title);
                doc.save(`chat_Gemini_${cleanTitle}`);
                this.showToast('הצ\'אט יוצא בהצלחה ל-PDF', 'success');
            }

            exportToDocx(chat, includeTimestamps, includeSystemPrompts) {
                let html = `<!DOCTYPE html>
        <html dir="rtl" lang="he">
        <head>
            <meta charset="UTF-8">
            <meta name="generator" content="GeminiClone">
            <meta name="progid" content="Word.Document">
            <title>${chat.title}</title>
            <style>
                @page WordSection1 {
                    size: A4;
                    margin: 2cm;
                }
                body { 
                    font-family: 'Arial', sans-serif; 
                    direction: rtl; 
                    line-height: 1.6; 
                    margin: 20px; 
                    text-align: right; 
                }
                .title { 
                    font-size: 24pt; 
                    font-weight: bold; 
                    text-align: center; 
                    margin-bottom: 20pt; 
                }
                .message { 
                    margin-bottom: 20pt; 
                }
                .user { 
                    color: #4285F4; 
                    font-weight: bold; 
                    font-size: 12pt; 
                }
                .assistant { 
                    color: #34A853; 
                    font-weight: bold; 
                    font-size: 12pt; 
                }
                .timestamp { 
                    color: #888; 
                    font-size: 10pt; 
                    margin-right: 10px; 
                }
                .content { 
                    margin-top: 5pt; 
                    white-space: pre-wrap; 
                    font-size: 11pt; 
                }
                .system-prompt { 
                    font-style: italic; 
                    background: #F8F9FA; 
                    padding: 10px; 
                    border-radius: 5px; 
                    margin-bottom: 20pt; 
                }
                h1 { font-size: 18pt; font-weight: bold; margin: 10pt 0; }
                h2 { font-size: 16pt; font-weight: bold; margin: 8pt 0; }
                h3 { font-size: 14pt; font-weight: bold; margin: 6pt 0; }
                ul, ol { margin: 10pt 20pt; padding: 0; }
                li { margin-bottom: 5pt; }
                code { 
                    background: #F4F4F4; 
                    padding: 2px 4px; 
                    border-radius: 3px; 
                    font-family: 'Courier New', Courier, monospace; 
                    font-size: 10pt; 
                }
                pre.code-block { 
                    background: #F4F4F4; 
                    padding: 10px; 
                    border: 1px solid #DDD; 
                    border-radius: 5px; 
                    font-family: 'Courier New', Courier, monospace; 
                    font-size: 10pt; 
                    white-space: pre-wrap; 
                }
                table { 
                    border-collapse: collapse; 
                    width: 100%; 
                    margin: 10pt 0; 
                }
                th, td { 
                    border: 1px solid #DDD; 
                    padding: 8px; 
                    text-align: right; 
                    font-size: 11pt; 
                }
                th { 
                    background: #F8F9FA; 
                    font-weight: bold; 
                }
                a { 
                    color: #1A73E8; 
                    text-decoration: none; 
                }
                a:hover { 
                    text-decoration: underline; 
                }
                strong { 
                    font-weight: bold; 
                }
                em { 
                    font-style: italic; 
                }
                u { 
                    text-decoration: underline; 
                }
            </style>
        </head>
        <body>
            <div class="title">${chat.title}</div>`;

                if (includeSystemPrompts && chat.systemPrompt && this.isSystemPromptAllowed(chat.systemPrompt)) {
                    html += `<div class="system-prompt">
                <div>System Prompt:</div>
                <div>${this.formatMessageContent(chat.systemPrompt)}</div>
            </div>`;
                }
                for (const msg of chat.messages) {
                    const role = msg.role === 'user' ? 'אתה' : this.getPromptIcon(chat.systemPrompt).label;
                    const roleClass = msg.role === 'user' ? 'user' : 'assistant';

                    html += `<div class="message">
                <div>
                    <span class="${roleClass}">${role}</span>`;

                    if (includeTimestamps) {
                        const time = new Date(msg.timestamp).toLocaleString('he-IL');
                        html += `<span class="timestamp">(${time})</span>`;
                    }

                    html += `</div>
                <div class="content">${this.formatMessageContent(msg.content)}</div>
            </div>`;
                }

                html += `</body></html>`;
                const blob = new Blob([new TextEncoder().encode(html)], {
                    type: 'application/msword'
                });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                const cleanTitle = this.cleanFileName(chat.title);
                link.download = `chat_Gemini_${cleanTitle}`;
                link.click();

                this.showToast('הצ\'אט יוצא בהצלחה ל-Word', 'success');
            }

            exportToText(chat, includeTimestamps, includeSystemPrompts) {
                let text = `${chat.title}\n\n`;

                if (includeSystemPrompts && chat.systemPrompt && this.isSystemPromptAllowed(chat.systemPrompt)) {
                    text += `System Prompt: ${chat.systemPrompt}\n\n`;
                }

                for (const msg of chat.messages) {
                    const role = msg.role === 'user' ? 'אתה' : this.getPromptIcon(chat.systemPrompt).label; // שימוש בשם העוזר

                    text += `${role}`;

                    if (includeTimestamps) {
                        const time = new Date(msg.timestamp).toLocaleString('he-IL');
                        text += ` (${time})`;
                    }

                    text += `:\n${msg.content}\n\n`;
                }

                const blob = new Blob([new TextEncoder().encode(text)], {
                    type: 'text/plain'
                });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                const cleanTitle = this.cleanFileName(chat.title);
                link.download = `chat_Gemini_${cleanTitle}`;
                link.click();

                this.showToast('הצ\'אט יוצא בהצלחה לטקסט', 'success');
            }

            initializeQuickActions() {
                document.querySelectorAll('.quick-action').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const action = btn.getAttribute('data-action');
                        this.handleQuickAction(action);
                    });
                });
            }

            async handleQuickAction(action) {
                const currentText = this.messageInput.value;

                if (action === 'translate') {
                    const isHebrew = /[\u0590-\u05FF]/.test(currentText);
                    const targetLang = isHebrew ? 'en' : 'he';
                    window.open(`https://translate.google.com/?sl=auto&tl=${targetLang}&text=${encodeURIComponent(currentText)}`, '_blank');
                    this.showToast('נפתח תרגום בגוגל', 'success');
                } else {
                    const prompts = {
                        summarize: 'סכם את הנושא הזה בצורה קצרה ומובנת: ',
                        explain: 'הסבר לי בפשטות מה זה: '
                    };

                    this.messageInput.value = prompts[action] + currentText;
                    this.updateCharCount();
                    this.messageInput.focus();
                }
            }

            handleContextMenu(e) {
                const messageElement = e.target.closest('.message');
                if (messageElement) {
                    e.preventDefault();
                    this.showContextMenu(e.pageX, e.pageY, messageElement);
                }
            }

            showContextMenu(x, y, messageElement) {
                this.contextMenu.style.display = 'block';
                this.contextMenu.style.left = x + 'px';
                this.contextMenu.style.top = y + 'px';

                const editItem = this.contextMenu.querySelector('[data-action="edit"]');
                if (messageElement.classList.contains('user')) {
                    editItem.style.display = '';
                } else {
                    editItem.style.display = 'none';
                }

                document.querySelectorAll('.context-item').forEach(item => {
                    item.onclick = () => {
                        const action = item.getAttribute('data-action');
                        this.handleContextAction(action, messageElement);
                        this.hideContextMenu();
                    };
                });
            }

            hideContextMenu() {
                this.contextMenu.style.display = 'none';
            }

            handleContextAction(action, messageElement) {
                const messageId = messageElement.getAttribute('data-message-id');

                switch (action) {
                    case 'copy':
                        const content = messageElement.querySelector('.message-content').innerText;
                        navigator.clipboard.writeText(content);
                        this.showToast('הועתק ללוח', 'success');
                        break;
                    case 'edit':
                        this.editMessage(messageId);
                        break;
                    case 'delete':
                        this.deleteMessage(messageId);
                        break;
                    case 'share':
                        const msg = messageElement.querySelector('.message-content').innerText;
                        navigator.clipboard.writeText(msg);
                        this.showToast('ההודעה הועתקה לשיתוף', 'success');
                        break;
                }
            }

            setLoading(loading) {
                this.isLoading = loading;
                if (!this.settings.hideLoadingOverlay) {
                    this.loadingOverlay.classList.toggle('active', loading);
                }
                this.sendBtn.disabled = loading || !this.messageInput.value.trim();

                let stopBtnInOverlay = document.getElementById('stopBtnInOverlay');
                if (!stopBtnInOverlay) {
                    stopBtnInOverlay = document.createElement('button');
                    stopBtnInOverlay.id = 'stopBtnInOverlay';
                    stopBtnInOverlay.className = 'stop-btn stop-btn-overlay';
                    stopBtnInOverlay.innerHTML = `<span class="material-icons">stop_circle</span> `;
                    stopBtnInOverlay.onclick = () => this.abortGeneration();
                    this.loadingOverlay.querySelector('.loading-content').appendChild(stopBtnInOverlay);
                }
                stopBtnInOverlay.style.display = (loading && !this.settings.hideLoadingOverlay) ? 'inline-flex' : 'none';

                this.stopBtn.style.display = 'none';

                if (!loading && this.loadingInterval) {
                    clearInterval(this.loadingInterval);
                    document.querySelectorAll('.step').forEach(step => {
                        step.classList.remove('active');
                    });
                }
                if (this.settings.hideLoadingOverlay) {
                    this.renderMessages();
                }
            }

            showToast(message, type = 'success') {
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.innerHTML = `
                    <span class="material-icons">${type === 'success' ? 'check_circle' : 'error'}</span>
                    <span>${message}</span>
                `;
                this.toastContainer.appendChild(toast);

                setTimeout(() => {
                    toast.style.animation = 'toastSlideUp 0.3s ease-out forwards';
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            }

            toggleVoiceRecording() {
                if ('webkitSpeechRecognition' in window) {
                    const recognition = new webkitSpeechRecognition();
                    recognition.continuous = false;
                    recognition.interimResults = false;
                    recognition.lang = 'he-IL';

                    recognition.onstart = () => {
                        this.micBtn.style.color = 'var(--accent-color)';
                        this.showToast('מתחיל להקליט...', 'success');
                    };

                    recognition.onresult = (event) => {
                        const transcript = event.results[0][0].transcript;
                        this.messageInput.value += transcript;
                        this.updateCharCount();
                    };

                    recognition.onend = () => {
                        this.micBtn.style.color = '';
                        this.showToast('ההקלטה הסתיימה', 'success');
                    };

                    recognition.onerror = () => {
                        this.micBtn.style.color = '';
                        this.showToast('שגיאה בהקלטה', 'error');
                    };

                    recognition.start();
                } else {
                    this.showToast('הדפדפן לא תומך בהקלטה קולית', 'error');
                }
            }

            handleAttachment() {
                const input = document.createElement('input');
                input.type = 'file';
                input.multiple = true;
                input.accept = 'image/png,image/jpeg,image/webp,image/heic,image/heif,application/pdf,text/plain,text/markdown,audio/wav,audio/mp3,audio/aiff,audio/aac,audio/ogg,audio/flac,video/mp4,video/mpeg,video/mov,video/avi,video/x-flv,video/mpg,video/webm,video/wmv,video/3gpp,text/x-c,text/x-c++,text/x-python,text/x-java,application/x-httpd-php,text/x-sql,text/html,.c,.cpp,.py,.java,.php.ts,.ts,.sql,.html,text/javascript,text/typescript';
                input.onchange = (e) => {
                    const allowedTypes = [
                        'image/png', 'image/jpeg', 'image/webp', 'image/heic', 'image/heif',
                        'application/pdf', 'text/plain', 'text/markdown',
                        'audio/wav', 'audio/mp3', 'audio/aiff', 'audio/aac', 'audio/ogg', 'audio/flac',
                        'video/mp4', 'video/mpeg', 'video/mov', 'video/avi', 'video/x-flv', 'video/mpg',
                        'video/webm', 'video/wmv', 'video/3gpp',
                        'text/x-c', 'text/x-c++', 'text/x-python', 'text/x-java', 'application/x-httpd-php',
                        'text/x-sql', 'text/html', 'text/javascript', 'text/typescript'
                    ];
                    const files = Array.from(e.target.files).filter(file => allowedTypes.includes(file.type));
                    if (files.length !== e.target.files.length) {
                        alert('נבחרו קבצים לא נתמכים. אנא בחרו רק קבצים נתמכים.');
                    }
                    this.files.push(...files);
                    this.renderFilePreview();
                };

                input.click();
            }

            handleDropFiles(fileList) {
                const files = Array.from(fileList)
                    .filter(file => this.allowedFileTypes.includes(file.type));

                if (files.length > 0) {
                    this.files.push(...files);
                    this.renderFilePreview();
                }

                const invalidFiles = Array.from(fileList)
                    .filter(file => !this.allowedFileTypes.includes(file.type));
                if (invalidFiles.length > 0) {
                    this.showToast('קבצים לא נתמכים הוסרו.', 'neutral');
                }
            }

            renderFilePreview() {
                this.filePreviewList.innerHTML = '';

                this.files.forEach((file, idx) => {
                    const icon = this.getFileIcon(file);
                    const el = document.createElement('div');
                    el.className = 'file-preview';
                    el.innerHTML = `
                        <span class="material-icons">${icon}</span>
                        <span title="${file.name}">${file.name.length > 18 ? file.name.slice(0,15)+'...' : file.name}</span>
                        <span>(${this.formatFileSize(file.size)})</span>
                        <button class="file-remove-btn" title="הסר" data-idx="${idx}">
                            <span class="material-icons">close</span>
                        </button>
                    `;

                    el.querySelector('.file-remove-btn').onclick = (e) => {
                        this.files.splice(idx, 1);
                        this.renderFilePreview();
                    };

                    this.filePreviewList.appendChild(el);
                });
            }

            getFileIcon(file) {
                if (file.type && file.type.startsWith('image/')) return 'image';
                if (file.type && file.type.startsWith('video/')) return 'movie';
                if (file.type && file.type.startsWith('audio/')) return 'audiotrack';
                if (file.type === 'application/pdf') return 'picture_as_pdf';
                if (file.type && file.type.includes('word')) return 'description';
                if (file.type && file.type.includes('excel')) return 'grid_on';
                if (file.type && file.type.includes('zip')) return 'folder_zip';
                if (file.type && file.type.startsWith('text/')) return 'article';
                return 'attach_file';
            }

            formatFileSize(size) {
                if (size < 1024) return size + 'B';
                if (size < 1024 * 1024) return (size / 1024).toFixed(1) + 'KB';
                return (size / 1024 / 1024).toFixed(1) + 'MB';
            }

            generateChatId() {
                return 'chat_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            }

            generateMessageId() {
                return 'msg_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            }

            saveChatData() {
                localStorage.setItem('gemini-chats', JSON.stringify(this.chats));
            }

            regenerateLastResponse() {
                if (!this.currentChatId || this.isLoading) {
                    this.showToast('לא ניתן לייצר מחדש כרגע', 'error');
                    return;
                }

                const messages = this.chats[this.currentChatId].messages;
                if (!messages || messages.length === 0) {
                    this.showToast('אין הודעות בצ\'אט', 'error');
                    return;
                }

                let userMessageIndex = messages.length - 1;
                while (userMessageIndex >= 0 && messages[userMessageIndex].role !== 'user') {
                    userMessageIndex--;
                }

                if (userMessageIndex < 0) {
                    this.showToast('לא נמצאה הודעת משתמש אחרונה', 'error');
                    return;
                }

                const lastUserMessage = messages[userMessageIndex];

                this.files = (lastUserMessage.files || []).filter(file => file.base64).map(file => ({
                    name: file.name,
                    size: file.size,
                    type: file.type,
                    base64: file.base64
                }));
                this.filess = this.files;
                this.renderFilePreview();

                this.chats[this.currentChatId].messages = messages.slice(0, userMessageIndex + 1);
                this.chats[this.currentChatId].updatedAt = new Date().toISOString();
                this.saveChatData();
                this.renderMessages();

                this.setLoading(true);
                this.startFakeProgressBar();
                this.showLoadingSteps();
                this.abortController = new AbortController();

                this.callGemini(lastUserMessage.content, this.abortController.signal, this.files)
                    .then(response => {
                        const assistantMessage = {
                            id: this.generateMessageId(),
                            role: 'assistant',
                            content: response,
                            timestamp: new Date().toISOString(),
                            model: this.currentModel,
                            vote: null
                        };

                        this.chats[this.currentChatId].messages.push(assistantMessage);
                        this.chats[this.currentChatId].updatedAt = new Date().toISOString();
                        this.saveChatData();
                        this.renderMessages();

                        setTimeout(() => {
                            this.chatContainer.scrollTop = this.chatContainer.scrollHeight;
                        }, 100);
                    })
                    .catch(error => {
                        if (error.name === 'AbortError') {
                            this.showToast('התגובה הופסקה', 'error');
                        } else if (error.message.includes('net::ERR_INTERNET_DISCONNECTED')) {
                            this.showToast('אין חיבור לאינטרנט. אנא בדוק את החיבור ונסה שוב', 'error');
                            console.error('Network Error:', error);
                        } else {
                            this.showToast('שגיאה ביצירת תשובה מחדש: ' + error.message, 'error');
                            console.error('API Error:', error);
                        }
                    })
                    .finally(() => {
                        this.setLoading(false);
                        this.stopFakeProgressBar();
                        this.files = [];
                        this.filess = [];
                        this.renderFilePreview();
                    });
            }
        } // End of GeminiClone class

        document.addEventListener('DOMContentLoaded', () => {
            const app = new GeminiClone();
            window.showLightbox = (src) => app.showLightbox(src);
        });
    </script>
</body>
</html>
